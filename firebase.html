<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, updateEmail, updatePassword } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { getFirestore, collection, addDoc, setDoc, updateDoc, getDoc, doc, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDuWqqoSEfawmsdJNQzIDKk6lfvEKAubmA",
      authDomain: "porsche-tms.firebaseapp.com",
      projectId: "porsche-tms",
      storageBucket: "porsche-tms.appspot.com",
      messagingSenderId: "267742806983",
      appId: "1:267742806983:web:7e8a7ed147f052676b8fe2"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // This is a list of the default values
    // as well as of all the possible fields that a user doc can have
    const userDefaultValues = {
      // Supplier fields
      supplier_visit_from: '',
      supplier_visit_to: '',
      supplier_special_request: '',
      supplier_access_zone: '',
      // supplier_has_form_submitted: 0 | 1
      supplier_has_form_submitted: '0',

      // Press fields
      press_workspot: '',
      press_publisher: '',
      press_media_type: '',
      press_visit_from: '',
      press_visit_to: '',
      press_special_request: '',
      // press_has_uploaded_id: 0 | 1
      press_has_uploaded_id: '0',
      // press_has_form_submitted: 0 | 1
      press_has_form_submitted: '0',

      // User fields
      user_email: '',
      // user_is_admin: 0 | 1
      user_is_admin: '0',
      // user_type: supplier | press
      user_type: '',
      // user_status: pending | ok
      user_status: 'pending',
    };

    /*
    * -----------------------------------------------------------------------------------------------------------
    * Auth functions
    * -----------------------------------------------------------------------------------------------------------
    */
    function setDefaultFields(user) {
      const userRef = doc(db, 'users', user.uid);

      userDefaultValues.user_email = user.email;

      setDoc(userRef, userDefaultValues, { merge: true })
      .then(() => {
        toastr.success('Default values successfully set');
        setTimeout(function() {
          window.location = "/account";
        }, 1000);
      })
      .catch((err) => {
        console.log('there was a problem updating the data', err);
        toastr.error('There was an error updating your info');
      });
    };

    // Sign Up
    function handleSignUp(e) {
        e.preventDefault();
        e.stopPropagation();
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        var confirm_password = document.getElementById("password-confirm").value;

        if(password == confirm_password){
        createUserWithEmailAndPassword(auth, email, password)
        .then(userCredential => {
          //Signed in
          const user = userCredential.user;
          setDefaultFields(user);
          userExtraInfo(e, user)
          toastr.success('user successfully created: ' + user.email);
        })
        .catch((error) => {
          const errorMessage = error.message;
          var errorText = document.getElementById('signup-error-message');
          console.log(errorMessage);
          errorText.innerHTML = errorMessage;
        });
      }else{
        toastr.error('Password confirmation does not match');
      }
   };
    //Add user's extra info to Firestore
    function userExtraInfo(e, user) {
      e.preventDefault();
      e.stopPropagation();
      const userRef = doc(db, 'users', user.uid);
      const user_firstname = document.getElementById('first-name');
      const user_lastname = document.getElementById('last-name');
      const user_address = document.getElementById('user_address');
      const user_company = document.getElementById('sign-up-company');

      setDoc(userRef, {
        user_firstname: user_firstname.value,
        user_lastname: user_lastname.value,
        user_address: user_address.value,
        user_company: user_company.value
      }, { merge: true })
      .then(() => {
        //console.log('press data successfully updated');
        userUploadImage(user);
      })
      .catch((err) => {
        console.log('there was a problem updating the data', err);
        toastr.error('There was an error updating your info');
      });
    }
    //Upload user's profile image
    function userUploadImage(user) {
      const profile_img = document.getElementById('profile_img');
      let fileItem = profile_img.files[0];
      const storageRef = ref(storage, 'profiles/' + user.uid);

      uploadBytes(storageRef, fileItem)
      .then((snapshot) => {
        toastr.success('You have submitted the form successfully');
      })
      .catch(err => {
        console.log('error uploading file', err);
        toastr.error('There was an error uploading the file');
      });
    }

    // Handle signIn
    function handleSignIn(e) {
        e.preventDefault();
        e.stopPropagation();
        const email = document.getElementById('signin-email').value;
        const password = document.getElementById('signin-password').value;
        signInWithEmailAndPassword(auth, email, password)
        .then(userCredential => {
          // Signed in
          const user = userCredential.user;
          alert('user logged in: ' + user.email);
          window.location = "/account"
        })
        .catch((error) => {
          const errorMessage = error.message;
          var errorText = document.getElementById('signin-error-message');
          console.log(errorMessage);
          errorText.innerHTML = errorMessage;
        });
    }

    // Handle signOut
    function handleSignOut() {
        signOut(auth).then(() => {
          alert('user signed out');
          window.location = "/signin";
        }).catch((error) => {
            const errorMessage = error.message;
            console.log(errorMessage);
        });
    }

    /*
    * -----------------------------------------------------------------------------------------------------------
    * Homepage functions
    * -----------------------------------------------------------------------------------------------------------
    */
    function pageHome() {
        //identify auth action forms
        let signUpForm = document.getElementById('wf-form-signup-form');

        //assign event listeners
        if ( typeof(signUpForm) !== null ) {
          signUpForm.addEventListener('submit', handleSignUp, true)
        }
    }

    function signInPage(){
        let signInForm = document.getElementById('wf-form-signin-form');
        
        //assign event listeners
        if(typeof(signInForm) !== null) {
          signInForm.addEventListener('submit', handleSignIn, true)
        }
    }

    let signOutButton = document.getElementById('signout-button');

    if(typeof signOutButton !== null) {
          signOutButton.addEventListener('click', handleSignOut);
        }

    /*
    * -----------------------------------------------------------------------------------------------------------
    * Account functions
    * -----------------------------------------------------------------------------------------------------------
    */
    async function getUserInfo(user) {
      const typeRef = doc(db, 'users', user.uid);
      const typeSnap = await getDoc(typeRef);
      if ( typeSnap.exists() ) {
        return typeSnap.data();
      } else {
        toastr.error('No user found with that ID');
      }
    }

    async function populateForms(user) {
      let userInfo = await getUserInfo(user);
      const accountType_button = document.getElementById('account_user_profile');
      const homeButton = document.getElementById('home_button');
      const press_info = document.getElementsByClassName('press_info');
      const supplier_info = document.getElementsByClassName('supplier_info');

      if ( userInfo ) {

        if ( userInfo.user_type == "Supplier" && userInfo.user_is_admin == '0') {
          if (window.location.pathname == '/account'){
            document.getElementById('welcome_user').innerHTML = `Hello Supplier ${userInfo.user_firstname}`;
            document.getElementById('account_type_info').innerHTML = `<b>Account type:</b> ${userInfo.user_type}`;
            for ( var i=0; i < supplier_info.length; i+=1 ){
              supplier_info[i].style.display = 'flex';
            }
          }
          accountType_button.setAttribute("href", "/supplier");
          homeButton.setAttribute("href", "/supplier");
        } else if( userInfo.user_type == "Press" && userInfo.user_is_admin == '0') {
          if(window.location.pathname == '/account'){
              document.getElementById('welcome_user').innerHTML = `Hello Press ${userInfo.user_firstname}`;
              document.getElementById('account_type_info').innerHTML = `<b>Account type:</b> ${userInfo.user_type}`;
              for (var i=0;i<press_info.length;i+=1){
              press_info[i].style.display = 'flex';
            }
          }
          accountType_button.setAttribute("href", "/press");
          homeButton.setAttribute("href", "/press");
        } else {
          if(window.location.pathname == '/account'){
            document.getElementById('welcome_user').innerHTML = `Hello ${userInfo.user_firstname}`;
            document.getElementById('account_type_info').innerHTML = '';
          }
          accountType_button.setAttribute("href", "/admin");
          homeButton.setAttribute("href", "/admin");
        }

        if(userInfo.admin == "1") {
          if(window.location.pathname == '/account') {
            document.getElementById('welcome_user').innerHTML = `Hello Admin ${userInfo.user_firstname}`;
            }
          }
          accountType_button.setAttribute("href", "/admin");

       if (window.location.pathname == '/supplier'){
        if(userInfo.supplier_has_form_submitted == "1"){
          document.getElementById("from_date").setAttribute('disabled', "");
          document.getElementById("to_date").setAttribute('disabled', "");
          document.getElementById("special_request").setAttribute('disabled', "");
          document.getElementById("zones").setAttribute('disabled', "");
        }
      }
       if (window.location.pathname == '/press'){
        if(userInfo.press_has_form_submitted == "1"){
          document.getElementById("workspot").setAttribute('disabled', "");
          document.getElementById("publisher").setAttribute('disabled', "");
          document.getElementById("media_type").setAttribute('disabled', "");
          document.getElementById("from_press_date").setAttribute('disabled', "");
          document.getElementById("to_press_date").setAttribute('disabled', "");
          document.getElementById("special_press_request").setAttribute('disabled', "");
          document.getElementById("fileInp").setAttribute('disabled', "");
        }
       }
      }
    }

    // Update username
    function updateUsername(e, user, newUsername) {
      e.preventDefault();
      e.stopPropagation();
      updateProfile(user, {
        displayName: newUsername
      })
      .then(() => {
        toastr.success('Username has been successfully updated');
        setTimeout(() => {
          location.reload();
        }, 2000);
      })
      .catch((error) => {
        toastr.error('There was a problem updating the username');
      });
    }

    // Update email
    function updateUserEmail(e, user, newEmail) {
      e.preventDefault();
      e.stopPropagation();
      updateEmail(user, newEmail)
      .then(() => {
        toastr.success('Email has been successfully updated');
        setTimeout(() => {
          location.reload();
        }, 2000);
      }).catch((error) => {
        toastr.error('There was a problem updating the email');
      });
    }

    // Update password
    function updateUserPassword(e, user, newPassword) {
      e.preventDefault();
      e.stopPropagation();
      updatePassword(user, newPassword)
      .then(() => {
        toastr.success('Password has been successfully updated');
        setTimeout(() => {
          location.reload();
        }, 2000);
      })
      .catch((error) => {
        toastr.error('There was a problem updating the password');
      });
    }

    //Display profile picture
    function showProfilePic(user){
      getDownloadURL(ref(storage, 'profiles/' + user.uid))
        .then((url) => {

          //insert into an <img> element
          const img = document.getElementById('user_profile_pic');
          img.setAttribute('src', url);
        })
        .catch((error) => {
          // Handle any errors
        });
    }

    //Update profile picture
    function updateProfilePic(e, user) {
      e.preventDefault();
      e.stopPropagation();

      const updated_picture = document.getElementById('updated_picture');
      let fileItem = updated_picture.files[0];
      const storageRef = ref(storage, 'profiles/' + user.uid);

      uploadBytes(storageRef, fileItem)
      .then((snapshot) => {
        toastr.success('You have updated the profile picture successfully');
      })
      .catch(err => {
        console.log('error uploading file', err);
        toastr.error('There was an error uploading the file');
      });
    }

    function showPrivateElements() {
      // User is signed in
      let publicElements = document.querySelectorAll("[data-onlogin='hide']");
      let privateElements = document.querySelectorAll("[data-onlogin='show']");
      privateElements.forEach(function(element) {
        element.style.display = "initial";
      });
      publicElements.forEach(function(element) {
        element.style.display = "none";
      });
    }

    function showPublicElements() {
      // User is signed out
      let publicElements = document.querySelectorAll("[data-onlogin='hide']");
      let privateElements = document.querySelectorAll("[data-onlogin='show']");
      publicElements.forEach(function(element) {
        element.style.display = "initial";
      });
      privateElements.forEach(function(element) {
        element.style.display = "none";
      });
    }

    function pageAccount(user) {
      // Populate form fields with values
      document.getElementById("user_email").innerHTML = `<span><b>Email:</b> ${user.email}</span>`;
      document.getElementById("user_password").innerHTML = `<span><b>Change Password</b></span>`;
      document.getElementById("account_type_info").innerHTML = ``;

      let update_email_modal = document.getElementById("email_form_modal");
      let update_password_modal = document.getElementById("password_form_modal");
      let update_picture_modal = document.getElementById("picture_form_modal");
      let change_email = document.getElementById("change_email");
      let change_username = document.getElementById("change_username");
      let change_password = document.getElementById("change_password");

      if ( update_email_modal !== null ) {
        update_email_modal.addEventListener('submit', function(ev) {
          updateUserEmail(ev, user, change_email.value);
        }, true);
      }
      if ( update_password_modal !== null ) {
        update_password_modal.addEventListener('submit', function(ev) {
          updateUserPassword(ev, user, change_password.value);
        }, true);
      }
      if ( update_picture_modal !== null ) {
        update_picture_modal.addEventListener('submit', function(ev) {
          updateProfilePic(ev, user);
        }, true);
      }

      showProfilePic(user)

    }

    /*
    * -----------------------------------------------------------------------------------------------------------
    * Press functions
    * -----------------------------------------------------------------------------------------------------------
    */
    function pressFormSubmit(e, user) {
      e.preventDefault();
      e.stopPropagation();
      const userRef = doc(db, 'users', user.uid);
      const workspot = document.getElementById('workspot');
      const publisher = document.getElementById('publisher');
      const media_type = document.getElementById('media_type');
      const from_press_date = document.getElementById('from_press_date');
      const to_press_date = document.getElementById('to_press_date');
      const special_press_request = document.getElementById('special_press_request');
      const press_email = user.email;

      setDoc(userRef, {
        press_visit_from: from_press_date.value,
        press_visit_to: to_press_date.value,
        press_special_request: special_press_request.value,
        press_workspot: workspot.value,
        press_publisher: publisher.value,
        press_media_type: media_type.value,
        press_has_form_submitted: "1",
        press_email: press_email
      }, { merge: true })
      .then(() => {
        //console.log('press data successfully updated');
        pressUploadImage(user);
      })
      .catch((err) => {
        console.log('there was a problem updating the data', err);
        toastr.error('There was an error updating your info');
      });
    }

    function pressUploadImage(user) {
      const press_id = document.getElementById('fileInp');
      let fileItem = press_id.files[0];
      const storageRef = ref(storage, 'press_id/' + user.uid);

      uploadBytes(storageRef, fileItem)
      .then((snapshot) => {
        toastr.success('You have submitted the form successfully');
        setTimeout(reloadFormPage, 3000);
      })
      .catch(err => {
        console.log('error uploading file', err);
        toastr.error('There was an error uploading the file');
      });
    }

    function pagePress(user) {
      // Show displayName
      document.getElementById("client_press").innerHTML = `Hello Press ${userInfo.user_firstname}`;

      // Get press form
      const press_form = document.getElementById('moreInfo_press_form');
      // Add submit event to form
      press_form.addEventListener('submit', function(ev) {
        pressFormSubmit(ev, user);
      });
    }

    /*
    * -----------------------------------------------------------------------------------------------------------
    * Supplier functions
    * -----------------------------------------------------------------------------------------------------------
    */

    function addSupplierInfo(e, user) {
      e.preventDefault();
      e.stopPropagation();

      const userRef = doc(db, 'users', user.uid);
      const from_date = document.getElementById('from_date');
      const to_date = document.getElementById('to_date');
      const special_request = document.getElementById('special_request');
      const access_zone = document.getElementById('zones');

      setDoc(userRef, {
        supplier_visit_from: from_date.value,
        supplier_visit_to: to_date.value,
        supplier_special_request: special_request.value,
        supplier_access_zone: access_zone.value,
        supplier_has_form_submitted: "1"
      }, { merge: true })
      .then(() => {
        toastr.success('You have submitted the form successfully');
        setTimeout(reloadFormPage, 3000);
      })
      .catch((err) => {
        console.log('error updating supplier info', err);
        toastr.error('There was an error updating your info');
      });
    }

    function reloadFormPage(){
        window.location.reload();
    }

    function pageSupplier(user) {
      // Show displayName
      document.getElementById("supplier_user").innerHTML = `Hello Supplier ${userInfo.user_firstname}`;

      const supplier_form = document.getElementById('supplier_form');
      supplier_form.addEventListener('submit', function(ev) {
        ev.preventDefault();
        addSupplierInfo(ev, user);
      });
    }

    /*
    * -----------------------------------------------------------------------------------------------------------
    * Admin functions
    * -----------------------------------------------------------------------------------------------------------
    */
    function pageAdmin(user) {
      let update_user_form = document.getElementById('update_user_type');
      let user_specific_id = document.getElementById('admin_user_id');
      let user_specific_email = document.getElementById('admin_user_email');
      let userTypeUpdate = document.getElementById('accountType');
      let user_status_update = document.getElementById('accountStatus');
      let user_company_update = document.getElementById('userCompany');
      let admin_cred = document.getElementById('is_admin');

      update_user_form.addEventListener('submit', (e) => {
        e.preventDefault();
        e.stopPropagation()

        if ( user_specific_id != null || user_specific_id != 0 ) {
          const userRef = doc(db, 'users', user_specific_id.value);
          setDoc(userRef, {
            user_type: userTypeUpdate.value,
            user_status: user_status_update.value,
            user_company: user_company_update.value
          }, { merge: true })
          .then(() => {
            try {
                const docRef = addDoc(collection(db, "mail"), {
                to: `${user_specific_email.value}`,
                message: {
                subject: 'Hello from Firebase!',
                html: 'This is an <code>HTML</code> email body.',
                }
                });
                console.log("Document written with ID: ", docRef.id);
                } catch (e) {
                console.error("Error adding document: ", e);
                }
            toastr.success('Account type has been successfully updated');
          })
          .catch((err) => {
            toastr.error('There was an error updating the account type');
            console.log('error updating account type', err);
          });
        }
      });

//Print users table
      const colRef = collection(db, 'users');
      let userList = document.getElementById('admin-user-list');

      getDocs(colRef)
      .then((snapshot) => {
        
        snapshot.docs.forEach((doc) => {
          var newRow = document.getElementById('user-list-body').insertRow(0);
          var cell1 = newRow.insertCell(0);
          var cell2 = newRow.insertCell(1);
          var cell3 = newRow.insertCell(2);
          var cell4 = newRow.insertCell(3);
          var cell5 = newRow.insertCell(4);

          let user = doc.data();
          cell1.innerHTML = `${doc.id}`;
          cell1.className = 'userID';
          cell2.innerHTML = `${user.user_email}`;
          cell2.className = 'userEmail';
          cell3.innerHTML = `${user.user_status}`;
          cell4.innerHTML = `${user.user_company}`;
          cell5.innerHTML = `<button id="open_modal_btn" onclick="openModal()" style="color:#fff;background-color:blue;border:none;border-radius:4px;padding:4px">Update</button>`;
        });
      })
      .catch(err => {
        console.log('error fetching users', err);
      })

      //Print companies table
      const company_colRef = collection(db, 'companies');
      let companyList = document.getElementById('admin-companies-list');

      getDocs(company_colRef)
      .then((snapshot) => {
        
        snapshot.docs.forEach((doc) => {
          var company_newRow = document.getElementById('companies-list-body').insertRow(0);
          var company_cell1 = company_newRow.insertCell(0);
          var company_cell2 = company_newRow.insertCell(1);
          var company_cell3 = company_newRow.insertCell(2);
          var company_cell4 = company_newRow.insertCell(3);
          var company_cell5 = company_newRow.insertCell(4);

          let user = doc.data();
          company_cell1.innerHTML = `${doc.id}`;
          company_cell1.className = 'companyID';
          company_cell2.innerHTML = `${user.company_name}`;
          company_cell2.className = 'company_name';
          company_cell3.innerHTML = `${user.company_zones}`;
          company_cell2.innerHTML = `${user.user_head}`;
          company_cell5.innerHTML = `<button id="open_modal_btn" onclick="openModal()" style="color:#fff;background-color:blue;border:none;border-radius:4px;padding:4px">Update</button>`;
        });
      })
      .catch(err => {
        console.log('error fetching users', err);
      })
    }

    /*
    * -----------------------------------------------------------------------------------------------------------
    * URL functions
    * -----------------------------------------------------------------------------------------------------------
    */

    /* Check if the company parameter exists in the URL
    /* If it does then set a value in the local storage
    /* and pre-populate the text field in the sign up form
    **/
    function checkUrlParameter() {

      let url = new URL(location.href);
      let company = url.searchParams.get('company');

      if ( company ) {
          localStorage.setItem('porsche_company', company);
          $('#sign-up-company').val(company);
      }
    }

    function dispatchRequest(user) {
      let url = window.location.pathname;
      console.log('url in dispatchRequest()', url);

      // User is NOT signed in
      if ( user == false ) {
        // Homepage
        if ( url == '/signup' ) {
          pageHome();
        } else if ( url == '/signin' ) {
          signInPage();
        } else {
          // User does NOT have access to this page
          console.log('user does NOT have access to this page');
        }
      } else {
        // User IS signed in
         if ( url == '/account' ) {
          pageAccount(user);
        } else if ( url == '/press' ) {
          pagePress(user);
        } else if ( url == '/supplier') {
          pageSupplier(user);
        } else if ( url == '/admin' ) {
          pageAdmin(user);
        }
      }
    }

    // first page load
    dispatchRequest(false);
    checkUrlParameter();

    onAuthStateChanged(auth, (user) => {
      if (user) {
        // user is signed in
        console.log(`The current user's UID is equal to ${user.uid}`);

        dispatchRequest(user);

        populateForms(user);

        showPrivateElements();
      } else {
        // user is signed out
        showPublicElements();
        return;
      }
    });

    $(document).ready(function () {
      // TODO: make sure to only call the datepicker function if an element exists
      // that should be rendered as a datepicker
      // otherwise a jquery error appears in the browser console
      $('[data-toggle="datepicker"]').datepicker({
        format: 'mm-dd-yyyy'
      });
      if (window.innerWidth < 768) {
        $('[data-toggle="datepicker"]').attr('readonly', 'readonly')
      }
    });

</script>
<script src="https://fengyuanchen.github.io/datepicker/js/datepicker.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
