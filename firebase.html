<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, updateEmail, updatePassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { getFirestore, collection, addDoc, setDoc, updateDoc, getDoc, doc, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDuWqqoSEfawmsdJNQzIDKk6lfvEKAubmA",
      authDomain: "porsche-tms.firebaseapp.com",
      projectId: "porsche-tms",
      storageBucket: "porsche-tms.appspot.com",
      messagingSenderId: "267742806983",
      appId: "1:267742806983:web:7e8a7ed147f052676b8fe2"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // This is a list of the default values
    // as well as of all the possible fields that a user doc can have
    const userDefaultValues = {
      // Supplier fields
      supplier_visit_from: '',
      supplier_visit_to: '',
      supplier_special_request: '',
      supplier_access_zone: '',
      // supplier_has_form_submitted: 0 | 1
      supplier_has_form_submitted: '0',

      // Press fields
      press_workspot: '',
      press_publisher: '',
      press_media_type: '',
      press_visit_from: '',
      press_visit_to: '',
      press_special_request: '',
      // press_has_uploaded_id: 0 | 1
      press_has_uploaded_id: '0',
      // press_has_form_submitted: 0 | 1
      press_has_form_submitted: '0',

      // User fields
      user_email: '',
      user_id: '',
      // user_is_admin: 0 | 1
      user_is_admin: '0',
      // user_type: supplier | press
      user_type: '',
      // user_status: pending | ok
      user_status: 'pending',
    };

    /*
    * -----------------------------------------------------------------------------------------------------------
    * Auth functions
    * -----------------------------------------------------------------------------------------------------------
    */
    async function setDefaultFields(user) {
      const userRef = doc(db, 'users', user.uid);
      // Use the `getCompanyType` function to get the company type
      const companyType = await getCompanyType(user);
      // Use the companyType variable to set the user_type field
      userDefaultValues.user_type = companyType;
      userDefaultValues.user_email = user.email;
      userDefaultValues.user_id = user.uid;
      // Use the setDoc function to set the userDefaultValues object
      setDoc(userRef, userDefaultValues, { merge: true })
      .then(() => {
        userUploadImage(user)
          toastr.success('Default values successfully set');
          setTimeout(function() {
              window.location = "/account";
          }, 1000);
      })
      .catch((err) => {
          console.log('there was a problem updating the data', err);
          toastr.error('There was an error updating your info');
      });
    };

    // Sign Up
    function handleSignUp(e) {
        e.preventDefault();
        e.stopPropagation();
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        var confirm_password = document.getElementById("password-confirm").value;

        if(password == confirm_password){
        createUserWithEmailAndPassword(auth, email, password)
        .then(userCredential => {
          //Signed in
          const user = userCredential.user;
          setDefaultFields(user);
          userExtraInfo(e, user);
          toastr.success('user successfully created: ' + user.email);
        })
        .catch((error) => {
          const errorMessage = error.message;
          var errorText = document.getElementById('signup-error-message');
          alert(errorMessage);
          errorText.innerHTML = errorMessage;
        });
      }else{
        toastr.error('Password confirmation does not match');
      }
   };
    //Add user's extra info to Firestore
    function userExtraInfo(e, user) {
      e.preventDefault();
      e.stopPropagation();
      const userRef = doc(db, 'users', user.uid);
      const user_firstname = document.getElementById('first-name');
      const user_lastname = document.getElementById('last-name');
      const user_address = document.getElementById('user_address');
      const user_company = document.getElementById('sign-up-company');

      setDoc(userRef, {
        user_firstname: user_firstname.value,
        user_lastname: user_lastname.value,
        user_address: user_address.value,
        user_company: user_company.value
      }, { merge: true })
      .then(() => {
        //console.log('press data successfully updated');
      })
      .catch((err) => {
        console.log('there was a problem updating the data', err);
        toastr.error('There was an error updating your info');
      });
    }
    //Upload user's profile image
    function userUploadImage(user) {
      const profile_img = document.getElementById('profile_img');
      let fileItem = profile_img.files[0];
      const storageRef = ref(storage, 'profiles/' + user.uid);

      uploadBytes(storageRef, fileItem)
      .then((snapshot) => {
        toastr.success('You have submitted the form successfully');
      })
      .catch(err => {
        console.log('error uploading file', err);
        toastr.error('There was an error uploading the file');
      });
    }

    // Handle signIn
    function handleSignIn(e) {
        e.preventDefault();
        e.stopPropagation();
        const email = document.getElementById('signin-email').value;
        const password = document.getElementById('signin-password').value;
        signInWithEmailAndPassword(auth, email, password)
        .then(userCredential => {
          // Signed in
          const user = userCredential.user;
          toastr.success('user logged in: ' + user.email);
          setTimeout(() => {
            window.location = "/account";
        }, 1000);
        })
        .catch((error) => {
          const errorMessage = error.message;
          var errorText = document.getElementById('signin-error-message');
          console.log(errorMessage);
          errorText.innerHTML = errorMessage;
        });
    }

    // Handle signOut
    function handleSignOut() {
        signOut(auth).then(() => {
          toastr.error('user signed out');
          setTimeout(() => {
            window.location = "/signin";
        }, 1000);
        }).catch((error) => {
            const errorMessage = error.message;
            console.log(errorMessage);
        });
    }

    /*
    * -----------------------------------------------------------------------------------------------------------
    * Homepage functions
    * -----------------------------------------------------------------------------------------------------------
    */
    function pageHome() {
        //identify auth action forms
        let signUpForm = document.getElementById('wf-form-signup-form');

        //assign event listeners
        if ( typeof(signUpForm) !== null ) {
          signUpForm.addEventListener('submit', handleSignUp, true)
        }
    }

    function signInPage(){
        let signInForm = document.getElementById('wf-form-signin-form');

        //assign event listeners
        if(typeof(signInForm) !== null) {
          signInForm.addEventListener('submit', handleSignIn, true)
        }
    }

      let signOutButton = document.getElementById('signout-button');
      
      if(signOutButton) {
          signOutButton.addEventListener('click', handleSignOut);
        }

    /*
    * -----------------------------------------------------------------------------------------------------------
    * Account functions
    * -----------------------------------------------------------------------------------------------------------
    */
    async function getUserInfo(user) {
      const typeRef = doc(db, 'users', user.uid);
      const typeSnap = await getDoc(typeRef);
      if ( typeSnap.exists() ) {
        return typeSnap.data();
      } else {
        toastr.error('No user found with that ID');
      }
    }

    async function populateForms(user) {
      let userInfo = await getUserInfo(user);
      const accountType_button = document.getElementById('account_user_profile');
      const press_info = document.getElementsByClassName('press_info');
      const supplier_info = document.getElementsByClassName('supplier_info');
      let form_button = document.getElementById('form_button');

      if ( userInfo ) {

        // Use the changeCompanyNameToID(user) function to get the company name
        const companyName = await changeCompanyNameToID(userInfo);
        userInfo.user_company_name = companyName;

        if (window.location.pathname === '/account') {
          document.getElementById('user_company_name').innerHTML = `<b>Company:</b> ${userInfo.user_company_name}`;
          document.getElementById('account_type_info').innerHTML = `<b>Account type:</b> ${userInfo.user_type}`;
          document.getElementById('user_address').innerHTML = `<b>Address:</b> ${userInfo.user_address}`;
        }
        if ( userInfo.user_type == "Supplier" && userInfo.user_is_admin == '0') {
          if (window.location.pathname == '/account'){
            document.getElementById('welcome_user').innerHTML = `Hello Supplier ${userInfo.user_firstname}`;
            for ( var i=0; i < supplier_info.length; i+=1 ){
              supplier_info[i].style.display = 'flex';
            }
          }
          form_button.setAttribute('href', '/supplier');
        } else if( userInfo.user_type == "Press" && userInfo.user_is_admin == '0') {
          if(window.location.pathname == '/account'){
              document.getElementById('welcome_user').innerHTML = `Hello Press ${userInfo.user_firstname}`;
              for (var i=0;i<press_info.length;i+=1){
              press_info[i].style.display = 'flex';
            }
          }
          form_button.setAttribute('href', '/press');
        } else if(userInfo.user_is_admin == "0") {
              if(window.location.pathname == '/admin'){
                location.replace('/account');
              }
              document.getElementById('admin_button').style.display = 'none';     
          }else if (userInfo.user_is_admin == "1") {          
            if(window.location.pathname == '/account') {
              document.getElementById('welcome_user').innerHTML = `Hello Admin ${userInfo.user_firstname}`;
              }
              document.getElementById('admin_button').style.display = 'inline-grid';        
          } else {
            if(window.location.pathname == '/account'){
              document.getElementById('welcome_user').innerHTML = `Hello ${userInfo.user_firstname}`;
              document.getElementById('account_type_info').innerHTML = '';
            }
          }

        if (window.location.pathname == '/supplier'){
          if(userInfo.supplier_has_form_submitted == "1"){
            document.getElementById("from_date").setAttribute('disabled', "");
            document.getElementById("to_date").setAttribute('disabled', "");
            document.getElementById("special_request").setAttribute('disabled', "");
            document.getElementById("zones").setAttribute('disabled', "");
            document.getElementById("supplier_submmited_form").style.display = 'block';
        }
      }
       if (window.location.pathname == '/press'){
        if(userInfo.press_has_form_submitted == "1"){
          document.getElementById("workspot").setAttribute('disabled', "");
          document.getElementById("publisher").setAttribute('disabled', "");
          document.getElementById("media_type").setAttribute('disabled', "");
          document.getElementById("from_press_date").setAttribute('disabled', "");
          document.getElementById("to_press_date").setAttribute('disabled', "");
          document.getElementById("special_press_request").setAttribute('disabled', "");
          document.getElementById("fileInp").setAttribute('disabled', "");
          document.getElementById("press_submmited_form").style.display = 'block';
        }
       }
      }
    }

    // Update username
    function updateUsername(e, user, newUsername) {
      e.preventDefault();
      e.stopPropagation();
      updateProfile(user, {
        displayName: newUsername
      })
      .then(() => {
        toastr.success('Username has been successfully updated');
        setTimeout(() => {
          location.reload();
        }, 2000);
      })
      .catch((error) => {
        toastr.error('There was a problem updating the username');
      });
    }

    // Update email
    function updateUserEmail(e, user, newEmail) {
      e.preventDefault();
      e.stopPropagation();
      updateEmail(user, newEmail)
      .then(() => {
        toastr.success('Email has been successfully updated');
        setTimeout(() => {
          location.reload();
        }, 2000);
      }).catch((error) => {
        toastr.error('There was a problem updating the email');
      });
    }

    // Update password
    function updateUserPassword(e, user, newPassword) {
      e.preventDefault();
      e.stopPropagation();
      updatePassword(user, newPassword)
      .then(() => {
        toastr.success('Password has been successfully updated');
        setTimeout(() => {
          location.reload();
        }, 2000);
      })
      .catch((error) => {
        toastr.error('There was a problem updating the password');
      });
    }

    //Display profile picture
    function showProfilePic(user){
      getDownloadURL(ref(storage, 'profiles/' + user.uid))
        .then((url) => {

          //insert into an <img> element
          const img = document.getElementById('user_profile_pic');
          img.setAttribute('src', url);
        })
        .catch((error) => {
          // Handle any errors
        });
    }

    //Update profile picture
    function updateProfilePic(e, user) {
      e.preventDefault();
      e.stopPropagation();

      const updated_picture = document.getElementById('updated_picture');
      let fileItem = updated_picture.files[0];
      const storageRef = ref(storage, 'profiles/' + user.uid);

      uploadBytes(storageRef, fileItem)
      .then((snapshot) => {
        toastr.success('You have updated the profile picture successfully');
        setTimeout(reloadFormPage, 3000);
      })
      .catch(err => {
        console.log('error uploading file', err);
        toastr.error('There was an error uploading the file');
      });
    }

    function showPrivateElements() {
      // User is signed in
      let publicElements = document.querySelectorAll("[data-onlogin='hide']");
      let privateElements = document.querySelectorAll("[data-onlogin='show']");
      privateElements.forEach(function(element) {
        element.style.display = "initial";
      });
      publicElements.forEach(function(element) {
        element.style.display = "none";
      });
    }

    function showPublicElements() {
      // User is signed out
      let publicElements = document.querySelectorAll("[data-onlogin='hide']");
      let privateElements = document.querySelectorAll("[data-onlogin='show']");
      publicElements.forEach(function(element) {
        element.style.display = "initial";
      });
      privateElements.forEach(function(element) {
        element.style.display = "none";
      });
    }

    function pageAccount(user) {
      // Populate form fields with values
      document.getElementById("user_email").innerHTML = `<span><b>Email:</b> ${user.email}</span>`;
      document.getElementById("user_password").innerHTML = `<span><b>Change Password</b></span>`;
      document.getElementById("account_type_info").innerHTML = ``;

      let update_email_modal = document.getElementById("email_form_modal");
      let update_password_modal = document.getElementById("password_form_modal");
      let update_picture_modal = document.getElementById("picture_form_modal");
      let change_email = document.getElementById("change_email");
      let change_username = document.getElementById("change_username");
      let change_password = document.getElementById("change_password");

      if ( update_email_modal !== null ) {
        update_email_modal.addEventListener('submit', function(ev) {
          updateUserEmail(ev, user, change_email.value);
        }, true);
      }
      if ( update_password_modal !== null ) {
        update_password_modal.addEventListener('submit', function(ev) {
          updateUserPassword(ev, user, change_password.value);
        }, true);
      }
      if ( update_picture_modal !== null ) {
        update_picture_modal.addEventListener('submit', function(ev) {
          updateProfilePic(ev, user);
        }, true);
      }

      showProfilePic(user)
    }
    /*
    * -----------------------------------------------------------------------------------------------------------
    * Press functions
    * -----------------------------------------------------------------------------------------------------------
    */
    function pressFormSubmit(e, user) {
      e.preventDefault();
      e.stopPropagation();
      const userRef = doc(db, 'users', user.uid);
      const workspot = document.getElementById('workspot');
      const publisher = document.getElementById('publisher');
      const media_type = document.getElementById('media_type');
      const from_press_date = document.getElementById('from_press_date');
      const to_press_date = document.getElementById('to_press_date');
      const special_press_request = document.getElementById('special_press_request');
      const press_email = user.email;

      setDoc(userRef, {
        press_visit_from: from_press_date.value,
        press_visit_to: to_press_date.value,
        press_special_request: special_press_request.value,
        press_workspot: workspot.value,
        press_publisher: publisher.value,
        press_media_type: media_type.value,
        press_has_form_submitted: "1",
        press_email: press_email
      }, { merge: true })
      .then(() => {
        //console.log('press data successfully updated');
        pressUploadImage(user);
      })
      .catch((err) => {
        console.log('there was a problem updating the data', err);
        toastr.error('There was an error updating your info');
      });
    }

    function pressUploadImage(user) {
      const press_id = document.getElementById('fileInp');
      let fileItem = press_id.files[0];
      const storageRef = ref(storage, 'press_id/' + user.uid);

      uploadBytes(storageRef, fileItem)
      .then((snapshot) => {
        toastr.success('You have submitted the form successfully');
        setTimeout(reloadFormPage, 3000);
      })
      .catch(err => {
        console.log('error uploading file', err);
        toastr.error('There was an error uploading the file');
      });
    }

    async function pagePress(user) {
      let userInfo = await getUserInfo(user);
      let update_picture_modal = document.getElementById("picture_form_modal");
      // Show displayName
      document.getElementById("client_press").innerHTML = `Hello Press ${userInfo.user_firstname}`;
      showProfilePic(user);

      // Get press form
      const press_form = document.getElementById('moreInfo_press_form');
      // Add submit event to form
      press_form.addEventListener('submit', function(ev) {
        pressFormSubmit(ev, user);
      });
      if ( update_picture_modal !== null ) {
        update_picture_modal.addEventListener('submit', function(ev) {
          updateProfilePic(ev, user);
        }, true);
      }
    }

    /*
    * -----------------------------------------------------------------------------------------------------------
    * Supplier functions
    * -----------------------------------------------------------------------------------------------------------
    */

    function addSupplierInfo(e, user) {
      e.preventDefault();
      e.stopPropagation();

      const userRef = doc(db, 'users', user.uid);
      const from_date = document.getElementById('from_date');
      const to_date = document.getElementById('to_date');
      const special_request = document.getElementById('special_request');
      const access_zone = document.getElementById('zones');

      setDoc(userRef, {
        supplier_visit_from: from_date.value,
        supplier_visit_to: to_date.value,
        supplier_special_request: special_request.value,
        supplier_access_zone: access_zone.value,
        supplier_has_form_submitted: "1"
      }, { merge: true })
      .then(() => {
        toastr.success('You have submitted the form successfully');
        setTimeout(reloadFormPage, 3000);
      })
      .catch((err) => {
        console.log('error updating supplier info', err);
        toastr.error('There was an error updating your info');
      });
    }

    function reloadFormPage(){
        window.location.reload();
    }

    async function pageSupplier(user) {
      let userInfo = await getUserInfo(user);
      // Show displayName
      document.getElementById("supplier_user").innerHTML = `Hello Supplier ${userInfo.user_firstname}`;
      showProfilePic(user);

      const supplier_form = document.getElementById('supplier_form');
      supplier_form.addEventListener('submit', function(ev) {
        ev.preventDefault();
        addSupplierInfo(ev, user);
      });
      let update_picture_modal = document.getElementById("picture_form_modal");
      if ( update_picture_modal !== null ) {
        update_picture_modal.addEventListener('submit', function(ev) {
          updateProfilePic(ev, user);
        }, true);
      }
     }

      /*
      * -----------------------------------------------------------------------------------------------------------
      * Admin functions
      * -----------------------------------------------------------------------------------------------------------
      */

      if(window.location.pathname == '/admin'){
      let clipboard = new ClipboardJS('[id^=copy-button-]');

        clipboard.on('success', function(e) {
          toastr.success('Text copied to clipboard: ' + e.text);
        });

        clipboard.on('error', function(e) {
          toastr.error('Failed to copy text: ', e);
        });
      }

     async function pageAdmin(user) {

      let userInfo = await getUserInfo(user);
      
      // Print users table
      const colRef = collection(db, 'users');
      let searchInput = document.getElementById("search-input");
      let table = new Tabulator("#admin-user-list", {
        //options here
        layout:"fitDataTable",      //fit columns to width of table
        responsiveLayout:"hide",  //hide columns that dont fit on the table
        addRowPos:"top",          //when adding a new row, add it to the top of the table
        history:true,             //allow undo and redo actions on the table
        pagination:"local",       //paginate the data
        paginationSize:7,         //allow 7 rows per page of data
        paginationSizeSelector:[7, 10, 15, 21],
        paginationCounter:"rows", //display count of paginated rows in footer
        movableColumns:true,      //fit columns to width of table
        responsiveLayout:"hide",  //hide columns that dont fit on the table
        columns:[
            {title:"Name", field:"name", sorter:"string", width:150},
            {title:"Email", field:"email", sorter:"string", width:150},
            {title:"Company", field:"company", sorter:"string", width:150, editor:"input", headerFilter:"list", headerFilterParams:{valuesLookup:true, clearable:true}},
            {title:"Type", field:"type", sorter:"string", width:150, editor:"input", headerFilter:"list", headerFilterParams:{valuesLookup:true, clearable:true}},
            {title:"Status", field:"status", sorter:"string", width:150, editor:"input", headerFilter:"list", headerFilterParams:{valuesLookup:true, clearable:true}},            
            
        ],
    search: function (searchTerm, row) {
        let term = searchTerm.toLowerCase();
        let rowData = row.getData();
        if (rowData.id.toLowerCase().indexOf(term) !== -1 ||
           rowData.email.toLowerCase().indexOf(term) !== -1 ||
           rowData.status.toLowerCase().indexOf(term) !== -1 ||
           rowData.company.toLowerCase().indexOf(term) !== -1 ||
           rowData.type.toLowerCase().indexOf(term) !== -1 ) {
            return true;
        }
        return false;
    },
});

getDocs(colRef)
    .then((snapshot) => {
        let data = [];
        snapshot.docs.forEach((doc) => {
            let user = doc.data();
            let userCompanyName;

            if (!user.user_company) {
                console.log(`User ${user.uid} does not have a user_company field defined`);
                return;
            }

            changeCompanyNameToID(user).then(companyName => {
                userCompanyName = companyName;
                data.push({name: user.user_firstname, email: user.user_email, company: userCompanyName, type: user.user_type, status: user.user_status});
                table.setData(data);
            });
        });
    })
    .catch(err => {
        console.log('error fetching users', err);
    });

      //Print companies table
      const company_colRef = collection(db, 'companies');
      let select = document.getElementById('userCompany');

      getDocs(company_colRef)
      .then((snapshot) => {
        snapshot.docs.forEach((doc) => {
          let company = doc.data();
          
          var opt = document.createElement('option');
          opt.value = doc.id;
          opt.textContent = company.company_name;
          select.appendChild(opt);
        });
      })
      .catch(err => {
        console.log('error fetching companies', err);
      })

      let update_user_form = document.getElementById('update_user_type');
      let user_specific_id = document.getElementById('admin_user_id');
      let user_specific_email = document.getElementById('admin_user_email');
      let userTypeUpdate = document.getElementById('accountType');
      let user_status_update = document.getElementById('accountStatus');
      let user_company_update = document.getElementById('userCompany');
      let admin_cred = document.getElementById('is_admin');

      update_user_form.addEventListener('submit', (e) => {
        e.preventDefault();
        e.stopPropagation()

        if ( user_specific_id != null || user_specific_id != 0 ) {
          const userRef = doc(db, 'users', user_specific_id.value);
          setDoc(userRef, {
            user_type: userTypeUpdate.value,
            user_status: user_status_update.value,
            user_company: user_company_update.value
          }, { merge: true })
          .then(() => {

            if(user_status_update.value == 'decline'){
              try {
                const docRef = addDoc(collection(db, "mail"), {
                to: `${user_specific_email.value}`,
                message: {
                subject: 'Sorry you have been declined',
                html: 'Sorry you have been declined',
                }
                });
                } catch (e) {
                console.error("Error declining user: ", e);
                }
                toastr.success('User registration declined');
                setTimeout(function() {
                  window.location.reload();
                }, 2000);
            }else{
            try {
                const docRef = addDoc(collection(db, "mail"), {
                to: `${user_specific_email.value}`,
                message: {
                subject: 'Hello from Firebase!',
                html: 'This is an <code>HTML</code> email body.',
                }
                });
                console.log("Document written with ID: ", docRef.id);
                } catch (e) {
                console.error("Error adding document: ", e);
                }
                toastr.success('Account info has been successfully updated');
                setTimeout(function() {
                  window.location.reload();
                }, 2000);
              }
          })
          .catch((err) => {
            toastr.error('There was an error updating the account info');
            console.log('error updating account info', err);
          });
          
        }
      });

     
      //Update company info
      let update_company_form = document.getElementById('update_company_info');
      let company_id = document.getElementById('company_id');
      let update_company = document.getElementById('update_company');
      let companyHead = document.getElementById('companyHead');
      let companyZone = document.getElementById('companyZone');

      update_company_form.addEventListener('submit', (e) => {
        e.preventDefault();
        e.stopPropagation()

        if ( company_id != null) {
          const companyRef = doc(db, 'companies', company_id.value);
          setDoc(companyRef, {
            company_name: update_company.value,
            company_zones: companyZone.value,
            user_head: companyHead.value
          }, { merge: true })
          .then(() => {
                toastr.success('Company info has been successfully updated');
                setTimeout(function() {
                  window.location.reload();
                }, 2000);
          })
          .catch((err) => {
            toastr.error('There was an error updating the company info');
            console.log('error updating company info', err);
          });
        }
      });
      
      //Create new companies
      let create_company_form = document.getElementById('create_company_form');
      let new_company_name = document.getElementById('newCompanyName');
      let new_company_type = document.getElementById('companyType');
      let new_company_zones = document.getElementById('newCompanyZones');

      async function createCompany(){

        const companyRef = await addDoc(collection(db, "companies"), {
            company_name: new_company_name.value,
            company_zones: new_company_zones.value,
            company_type: new_company_type.value,
            user_head: ''
          })
          .then(() => {
                toastr.success('Company has been successfully created');
                setTimeout(function() {
                  window.location.reload();
                }, 2000);
          })
          .catch((err) => {
            toastr.error('There was an error creating the company');
            console.log('error creating company', err);
          });
      }

      create_company_form.addEventListener('submit', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        createCompany();
      });
    }

    //Company page
    $(document).on( 'click' , '#companyName' ,async function() {

          let companyValue = event.target.getAttribute('data-value');
          let companyNameValue = event.target.getAttribute('data-company-name');
          const q = query(collection(db, "users"), where("user_company", "==", companyValue));
          const company_filter = query(collection(db, "companies"), where("company_name", "==", companyNameValue));
          const companySnapshot = await getDocs(company_filter);
          const querySnapshot = await getDocs(q);
          let users = [];
          let company = [];

          querySnapshot.forEach((doc) => {
            let user = doc.data(q);
            users.push(user)
          });
           //Get company name from the companies collection
          companySnapshot.forEach((doc) => {
            let company_name = doc.data(company_filter);
            company.push(company_name)
          });

          console.log(company)
          localStorage.setItem('users', JSON.stringify(users));
          localStorage.setItem('company', companyValue);
          

          //Save company name from the companies collection
          localStorage.setItem('company_collection', JSON.stringify(company));

          window.location.replace('/company');
      })

    if (window.location.pathname == '/company'){

      // Retrieve users data from local storage
      const storedUsers = localStorage.getItem('users');
      const company_name = localStorage.getItem('company');
      const company_collection = localStorage.getItem('company_collection');
      const parseCompany = JSON.parse(company_collection);
      const users = JSON.parse(storedUsers);

    // Add rows and cells to table
    users.forEach(function(user) {
      var newRow = document.getElementById('company-user-list-body').insertRow(0);
      let idCell = newRow.insertCell(0);
      let emailCell = newRow.insertCell(1);
      let userTypeCell = newRow.insertCell(2);
      idCell.innerHTML = `${user.user_id}`;
      emailCell.innerHTML = `${user.user_email}`;
      userTypeCell.innerHTML = `${user.user_type}`;
    });

    //Add company head
        parseCompany.forEach(function(company){
      if(company.hasOwnProperty('user_head')){
        document.getElementById('user_head').innerHTML = `User head: ${company.user_head}`
      }
      if(company.hasOwnProperty('company_name')){
        document.getElementById('company_table_name').innerHTML = `Company: ${company.company_name}`
      }
    })
  }

    /*
    * -----------------------------------------------------------------------------------------------------------
    * URL functions
    * -----------------------------------------------------------------------------------------------------------
    */

    /* Check if the company parameter exists in the URL
    /* If it does then set a value in the local storage
    /* and pre-populate the text field in the sign up form
    **/
    function checkUrlParameter() {

      let url = new URL(window.location.href);
      let company = url.searchParams.get('company');

      if ( company ) {
          localStorage.setItem('company', company);
          $('#sign-up-company').val(company);
      }else{
        $('#sign-up-company').val(' ');
      }
    }

    function dispatchRequest(user) {
      let url = window.location.pathname;
      console.log('url in dispatchRequest()', url);

      // User is NOT signed in
      if ( user == false ) {
        // Homepage

        let signOutbutton = document.getElementById('signout-button');
         if(signOutbutton){
          signOutbutton.style.display = 'none';
         }

        if ( url == '/signup' ) {
          pageHome();
        } else if ( url == '/signin' ) {
          signInPage();
        } else {
          // User does NOT have access to this page
          console.log('user does NOT have access to this page');
        }
      } else {
        document.getElementById('signout-button').style.display = 'inline-grid';
        // User IS signed in
         if ( url == '/account' ) {
          pageAccount(user);
        } else if ( url == '/press' ) {
          pagePress(user);
        } else if ( url == '/supplier') {
          pageSupplier(user);
        } else if ( url == '/admin' ) {
          pageAdmin(user);
        }
      }
    }
    // Forgot password functionality
    if(window.location.pathname == '/forgotpassword'){

      let email = document.getElementById('email_address');
      let resetPasword = document.getElementById('forgot_password');

      resetPasword.addEventListener('submit', function(e){
        e.preventDefault();
        e.stopPropagation();

        sendPasswordResetEmail(auth, email.value)
        .then(() => {
          toastr.success('Email has been sent!');
          setTimeout(function() {
                  window.location.reload();
                }, 2000);
        })
        .catch((error) => {
          const errorCode = error.code;
          const errorMessage = error.message;
          toastr.error('There was an error');
          // ..
        });
      })
    };
    //Location redirect when the user is logged out
    function replaceUrl(user) {
        let form_button = document.getElementById('form_button');
        let account_button = document.getElementById('account_user_profile');
        let admin_button = document.getElementById('admin_button');

      if(!user){
        form_button.setAttribute('href', '/signin');
        account_button.setAttribute('href', '/signin');
        admin_button.setAttribute('href', '/signin');
        document.getElementById('signIn_button').style.display = 'inline-grid'; 
        document.getElementById('signUp_button').style.display = 'inline-grid';
      }else{
        account_button.setAttribute('href', '/account');
        admin_button.setAttribute('href', '/admin');
        document.getElementById('signIn_button').style.display = 'none'; 
        document.getElementById('signUp_button').style.display = 'none';
      }
    }
    // first page load
    dispatchRequest(false);
    checkUrlParameter();    

    async function changeCompanyNameToID(user) {
    // Get the collection of companies
    const companiesRef = collection(db, "companies");
    // Get all the company documents
    const companiesSnapshot = await getDocs(companiesRef);
    let companyName;
    // Iterate over the companies and find the one with the matching ID
    for (const company of companiesSnapshot.docs) {
        if (company.id === user.user_company) {
            companyName = company.data().company_name;
            break;
        }
    }
    // If a company with the matching ID is found
    if (companyName) {
        // Return the company name
        return companyName;
    } else {
        console.log("No company found with that ID");
    }
}

async function getCompanyType(user) {
  let userInfo = await getUserInfo(user);
    // Get the collection of companies
    const companiesRef = collection(db, "companies");
    // Get all the company documents
    const companiesSnapshot = await getDocs(companiesRef);
    let companyType;
    // Iterate over the companies and find the one with the matching ID
    for (const company of companiesSnapshot.docs) {
        if (company.id === userInfo.user_company) {
            companyType = company.data().company_type;
            break;
        }
    }
    // If a company with the matching ID is found
    if (companyType) {
        // Return the company type
        return companyType;
    } else {
        console.log("No company found with that ID");
    }
}

    onAuthStateChanged(auth, (user) => {
      replaceUrl(user);
      if (user) {
        // user is signed in
        console.log(`The current user's UID is equal to ${user.uid}`);
        
        dispatchRequest(user);
        populateForms(user);
        showPrivateElements();
        
      } else {
        // user is signed out
        showPublicElements();
        return;
      }
    });

    $(document).ready(function () {
      // TODO: make sure to only call the datepicker function if an element exists
      // that should be rendered as a datepicker
      // otherwise a jquery error appears in the browser console
      $('[data-toggle="datepicker"]').datepicker({
        format: 'mm-dd-yyyy'
      });
      if (window.innerWidth < 768) {
        $('[data-toggle="datepicker"]').attr('readonly', 'readonly')
      }
    });

</script>
<script src="https://fengyuanchen.github.io/datepicker/js/datepicker.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.10/dist/clipboard.min.js"></script>