<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase</title>
</head>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, updateEmail, updatePassword, sendPasswordResetEmail, deleteUser, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { getFirestore, collection, addDoc, setDoc, updateDoc, getDoc, doc, query, where, getDocs, deleteDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDuWqqoSEfawmsdJNQzIDKk6lfvEKAubmA",
      authDomain: "porsche-tms.firebaseapp.com",
      projectId: "porsche-tms",
      storageBucket: "porsche-tms.appspot.com",
      messagingSenderId: "267742806983",
      appId: "1:267742806983:web:7e8a7ed147f052676b8fe2"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const user = auth.currentUser;


    // This is a list of the default values
    // as well as of all the possible fields that a user doc can have
    const userDefaultValues = {
      // Supplier fields
      supplier_visit_dates: '',
      supplier_special_request: '',
      supplier_access_zone: '',
      // supplier_has_form_submitted: 0 | 1
      supplier_has_form_submitted: '0',

      // Press fields
      press_workspot: '',
      press_publisher: '',
      press_media_type: '',
      press_visit_dates: '',
      press_special_request: '',
      // press_has_uploaded_id: 0 | 1
      press_has_uploaded_id: '0',
      // press_has_form_submitted: 0 | 1
      press_has_form_submitted: '0',

      // User fields
      user_email: '',
      user_id: '',
      // user_is_admin: 0 | 1
      user_is_admin: '0',
      company_admin: '0',
      user_zones: '',
      // user_type: supplier | press
      user_type: '',
      // user_status: pending | ok
      user_status: 'pending',
      //user first sign
      first_sign: "0"
    };

    /*
    * -----------------------------------------------------------------------------------------------------------
    * Auth functions
    * -----------------------------------------------------------------------------------------------------------
    */

    async function setDefaultFields(user) {
    const userRef = doc(db, 'users', user.uid);
    // Use the `getCompanyType` function to get the company type and zones
    const { companyProfile, companyZones } = await getCompanyType(user);
    // Use the companyProfile variable to set the user_type field
    userDefaultValues.user_type = companyProfile;
    userDefaultValues.user_email = user.email;
    userDefaultValues.user_id = user.uid;
    // Use the companyZones variable to set the user_zones field
    userDefaultValues.user_zones = companyZones;
    var storedLang = localStorage.getItem("language");
    // Use the setDoc function to set the userDefaultValues object
    setDoc(userRef, userDefaultValues, { merge: true })
        .then(() => {
            userUploadImage(user);
            if (companyProfile == 'No company'){
                toastr.success('You are signing up with no company set');
            } else {
                toastr.success('Default values successfully set');
            }
            setTimeout(function() {
                if (storedLang) {
                    if (storedLang == "de") {
                        window.location = "/de/account";
                    } else {
                        window.location = "/en/account";
                    }
                } else {
                    window.location = "/en/account";
                }
            }, 1000);
        })
        .catch((err) => {
            console.log('there was a problem updating the data', err);
            toastr.error('There was an error updating your info');
        });
    };

    // Sign Up
    function handleSignUp(e) {
        e.preventDefault();
        e.stopPropagation();
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        var confirm_password = document.getElementById("password-confirm").value;
        const profile_img = document.getElementById('profile_img');

        if (profile_img.files.length === 0) {
              toastr.error('Please upload your profile picture')
            }else{
              if(password == confirm_password){
              createUserWithEmailAndPassword(auth, email, password)
              .then(userCredential => {
                //Signed in
                const user = userCredential.user;
                setDefaultFields(user);
                userExtraInfo(e, user);
                toastr.success('user successfully created: ' + user.email);
              })
              .catch((error) => {
                const errorMessage = error.message;
                var errorText = document.getElementById('signup-error-message');
                alert(errorMessage);
                errorText.innerHTML = errorMessage;
              });
            }else{
              toastr.error('Password confirmation does not match');
            }
          }
    };
    //Add user's extra info to Firestore
    function userExtraInfo(e, user) {
      e.preventDefault();
      e.stopPropagation();
      const userRef = doc(db, 'users', user.uid);
      const user_firstname = document.getElementById('first-name');
      const user_lastname = document.getElementById('last-name');
      const user_address = document.getElementById('user_address');
      const user_company = document.getElementById('sign-up-company');

      setDoc(userRef, {
        user_firstname: user_firstname.value,
        user_lastname: user_lastname.value,
        user_address: user_address.value,
        user_company: user_company.value,
        last_signin_date: new Date()
      }, { merge: true })
      .then(() => {
        //console.log('press data successfully updated');
      })
      .catch((err) => {
        console.log('there was a problem updating the data', err);
        toastr.error('There was an error updating your info');
      });
    }

    //Upload user's profile image
const profile_img = document.getElementById('profile_img');
const hiddenProfileInput = document.getElementById('hidden_profile_img');
var modal4 = document.getElementById("cropper_modal");

let profile_cropper;
if (profile_img) {
  profile_img.addEventListener("change", function handleProfilePic(e) {
    e.preventDefault();
    e.stopPropagation();

    let fileItem = profile_img.files[0];

    if (profile_img.files.length === 0) {
      toastr.error('Please upload your profile picture');
    } else {
      // Check if the file is an image
      if (/^image\/\w+/.test(fileItem.type)) {
        // Open the modal
        modal4.style.display = "block";        
        // Initialize the cropper
        const image = document.getElementById('profile_image_cropper');
        image.src = URL.createObjectURL(fileItem);
        profile_cropper = new Cropper(image, {
          aspectRatio: 3 / 4,
          width: 300,
          height: 300,
          viewMode: 2,
          autoCropArea: 1,
          responsive: true,
          crop(event) {
            // Get the cropped canvas data as a data URL
            const canvas = profile_cropper.getCroppedCanvas();
            const dataURL = canvas.toDataURL();

            // Set the data URL as the value of the hidden input field
            hiddenProfileInput.value = dataURL;
          },
        });
      } else {
        toastr.error('Please choose an image file.');
      }
    }
  });
}
  function userUploadImage(user) {
    const canvas = profile_cropper.getCroppedCanvas();
    canvas.toBlob((blob) => {
      const storageRef = ref(storage, 'profiles/' + user.uid);
      uploadBytes(storageRef, blob)
        .then((snapshot) => {
          toastr.success('You have updated the profile picture successfully');
          setTimeout(reloadPage, 3000);
        })
        .catch(err => {
          console.log('error uploading file', err);
          toastr.error('There was an error uploading the file');
        });
    });
  }
  //Handle singin
  async function handleSignIn(e) {
  let storedLang = localStorage.getItem("language");
  e.preventDefault();
  e.stopPropagation();
  const email = document.getElementById('signin-email').value;
  const password = document.getElementById('signin-password').value;

  try {
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    const userRef = doc(db, 'users', user.uid);
    const docSnap = await getDoc(userRef);

    if (docSnap.exists) {
      const userData = docSnap.data();
      toastr.success('user logged in: ' + user.email);
      setTimeout(() => {
        if (storedLang) {
          if (storedLang === "de") {
            if (userData.user_is_admin === "0" && userData.user_type === "Press") {
              window.location = "/de/press";
            } else if (userData.user_is_admin === "0" && userData.user_type === "Supplier") {
              window.location = "/de/supplier";
            } else if (userData.user_is_admin === "1") {
              window.location = "/de/admin/users-table";
            } else if (userData.user_is_admin === "0" && userData.company_admin == '1') {
              window.location = "/de/admin/users-table";
            }
          } else {
            if (userData.user_is_admin === "0" && userData.user_type === "Press") {
              window.location = "/en/press";
            } else if (userData.user_is_admin === "0" && userData.user_type === "Supplier") {
              window.location = "/en/supplier";
            } else if (userData.user_is_admin === "1") {
              window.location = "/en/admin/users-table";
            } else if (userData.user_is_admin === "0" && userData.company_admin == '1') {
              window.location = "/en/admin/users-table";
            }
          }
        } else {
          if (userData.user_is_admin === "0" && userData.user_type === "Press") {
            window.location = "/en/press";
          } else if (userData.user_is_admin === "0" && userData.user_type === "Supplier") {
            window.location = "/en/supplier";
          } else if (userData.user_is_admin === "1") {
            window.location = "/en/admin/users-table";
          }
        }
      }, 1000);
    } else {
      toastr.error('user does not exist');
    }
  } catch (error) {
    const errorMessage = error.message;
    toastr.error(errorMessage);
  }
}


    // Handle signOut
    function handleSignOut() {
      var storedLang = localStorage.getItem("language");
        signOut(auth).then(() => {          
          setTimeout(() => {
            toastr.error('user signed out');
        }, 1000);
        setTimeout(() => {
          if(storedLang){
            if(storedLang == "de" && window.location.pathname != "/de/signin-porsche"){
              window.location = "/de/signin-porsche";
            }else{
              window.location = "/en/signin-porsche";
            }
          }else{
            window.location = "/en/signin-porsche";
          }
            
        }, 1500);
        }).catch((error) => {
            const errorMessage = error.message;
            console.log(errorMessage);
        });
    }

    /*
    * -----------------------------------------------------------------------------------------------------------
    * Homepage functions
    * -----------------------------------------------------------------------------------------------------------
    */
    function pageHome() {
        //identify auth action forms
        let signUpForm = document.getElementById('wf-form-signup-form');

        //assign event listeners
        if ( typeof(signUpForm) !== null ) {
          signUpForm.addEventListener('submit', handleSignUp, true)
        }
    }
    function signInPage(){
        let signInForm = document.getElementById('wf-form-signin-form');

        //assign event listeners
        if(typeof(signInForm) !== null) {
          signInForm.addEventListener('submit', handleSignIn, true)
        }
    }
      let signOutButton = document.getElementById('signout-button');      
      if(signOutButton) {
          signOutButton.addEventListener('click', handleSignOut);
        }

    /*
    * -----------------------------------------------------------------------------------------------------------
    * Account functions
    * -----------------------------------------------------------------------------------------------------------
    */
    async function getUserInfo(user) {
      const typeRef = doc(db, 'users', user.uid);
      const typeSnap = await getDoc(typeRef);
      if ( typeSnap.exists() ) {
        return typeSnap.data();
      } else {
        toastr.error('No user found with that ID');
      }
    }

    async function populateForms(user) {
      let userInfo = await getUserInfo(user);
      const accountType_button = document.getElementById('account_user_profile');
      const press_info = document.getElementsByClassName('press_info');
      const supplier_info = document.getElementsByClassName('supplier_info');
      let form_button = document.getElementById('form_button');
      var storedLang = localStorage.getItem("language");

      if ( userInfo ) {
        // Use the changeCompanyNameToID(user) function to get the company name
        const companyNames = await changeCompanyNameToID(userInfo);
        userInfo.user_company_name = companyNames;

        if (window.location.pathname === '/en/account' || window.location.pathname === '/de/account') {
          document.getElementById('user_address').innerHTML = `${userInfo.user_address}`;
          document.getElementById('user_name').innerHTML = `${userInfo.user_firstname}`;
          document.getElementById('user_lastname').innerHTML = `${userInfo.user_lastname}`;
            }
        if(storedLang){
          if(storedLang == "de"){
            if( userInfo.user_type == "No company" && userInfo.user_is_admin == '0'){
            form_button.setAttribute('href', '/de/supplier');
          }else if ( userInfo.user_type == "Supplier" && userInfo.user_is_admin == '0') {
          form_button.setAttribute('href', '/de/supplier');
        } else if( userInfo.user_type == "Press" && userInfo.user_is_admin == '0') {
          form_button.setAttribute('href', '/de/press');
        } else if(userInfo.user_is_admin == "0" && userInfo.company_admin == "1") {
              if(window.location.pathname == '/de/users-table' || window.location.pathname == '/de/companies-table'){
                location.replace('/de/account');
              }
              document.getElementById('admin_button').style.display = 'block';   
          }else if (userInfo.user_is_admin == "1" || userInfo.company_admin == "1") {
              form_button.setAttribute('href', '/de/supplier');
              document.getElementById('admin_button').style.display = 'block';
          }else{}
          }else{
              if( userInfo.user_type == "No company" && userInfo.user_is_admin == '0'){
              form_button.setAttribute('href', '/en/supplier');
              }else if ( userInfo.user_type == "Supplier" && userInfo.user_is_admin == '0') {
              form_button.setAttribute('href', '/en/supplier');
              } else if( userInfo.user_type == "Press" && userInfo.user_is_admin == '0') {
              form_button.setAttribute('href', '/en/press');
              } else if(userInfo.user_is_admin == "0" && userInfo.company_admin != "1") {
                  if(window.location.pathname == '/en/users-table' || window.location.pathname == '/en/companies-table'){
                    location.replace('/en/account');
                  }
                  document.getElementById('admin_button').style.display = 'none';     
              }else if (userInfo.user_is_admin == "1") {
                  form_button.setAttribute('href', '/en/supplier');
                  document.getElementById('admin_button').style.display = 'block';
              }else{}
              }
        }else{
          if( userInfo.user_type == "No company" && userInfo.user_is_admin == '0'){
              form_button.setAttribute('href', '/en/supplier');
              }else if ( userInfo.user_type == "Supplier" && userInfo.user_is_admin == '0') {
              form_button.setAttribute('href', '/en/supplier');
              } else if( userInfo.user_type == "Press" && userInfo.user_is_admin == '0') {
              form_button.setAttribute('href', '/en/press');
              } else if(userInfo.user_is_admin == "0") {
                  if(window.location.pathname == '/en/users-table' || window.location.pathname == '/en/companies-table' && userInfo.company_admin != "1"){
                    location.replace('/en/account');
                  }
                  document.getElementById('admin_button').style.display = 'none';     
              }else if (userInfo.user_is_admin == "1") {
                  form_button.setAttribute('href', '/en/supplier');
                  document.getElementById('admin_button').style.display = 'block';
              }else{}
          }
        if (window.location.pathname == '/de/supplier' || window.location.pathname == '/en/supplier'){
          if(userInfo.supplier_has_form_submitted == "1"){
            document.getElementById("Select-dates").setAttribute('disabled', "");
            document.getElementById("Special-request-2").setAttribute('disabled', "");
            document.getElementById("supplier_submmited_form").style.display = 'flex';
        }
        }
       if (window.location.pathname == '/de/press' || window.location.pathname == '/en/press'){
        if(userInfo.press_has_form_submitted == "1"){
          document.getElementById("workspot").setAttribute('disabled', "");
          document.getElementById("publisher").setAttribute('disabled', "");
          document.getElementById("media_type").setAttribute('disabled', "");
          document.getElementById("Select-dates").setAttribute('disabled', "");
          document.getElementById("special_press_request").setAttribute('disabled', "");
          document.getElementById("fileInp").setAttribute('disabled', "");
          document.getElementById("press_submmited_form").style.display = 'flex';
        }
       }
      }
    }

    // Update username
    function updateUsername(e, user, newUsername) {
      e.preventDefault();
      e.stopPropagation();
      updateProfile(user, {
        displayName: newUsername
      })
      .then(() => {
        toastr.success('Username has been successfully updated');
        setTimeout(() => {
          location.reload();
        }, 2000);
      })
      .catch((error) => {
        toastr.error('There was a problem updating the username');
      });
    }

    // Update email
    function updateUserEmail(e, user, newEmail) {
      updateEmail(user, newEmail)
      .then(() => {
        toastr.success('Email has been successfully updated');
        setTimeout(() => {
          document.getElementById('update_info_modal').style.display = 'none';
          $('body').removeClass('modal-open');
        }, 500);
      }).catch((error) => {
        toastr.error('There was a problem updating the email');
      });
    }

    // Update password
    function updateUserPassword(e, user, newPassword) {
      updatePassword(user, newPassword)
      .then(() => {
        toastr.success('Password has been successfully updated');
        setTimeout(() => {
          document.getElementById('update_info_modal').style.display = 'none';
          $('body').removeClass('modal-open');
        }, 500);
      })
      .catch((error) => {
        toastr.error('There was a problem updating the password', error);
      });
    }

    //Display profile picture
    function showProfilePic(user){
      getDownloadURL(ref(storage, 'profiles/' + user.uid))
        .then((url) => {

          //insert into an <img> element
          const img = document.getElementById('user_profile_pic');
          img.setAttribute('src', url);
        })
        .catch((error) => {
          // Handle any errors
        });
    }

  const updatedPicture = document.getElementById('updated_picture');
  const hiddenInput = document.getElementById('hidden_input');
  let cropper;
if(updatedPicture){
updatedPicture.addEventListener("change", function handleProfilePic(e) {
  e.preventDefault();
  e.stopPropagation();

  let fileItem = updatedPicture.files[0];

  if (updatedPicture.files.length === 0) {
    toastr.error('Please upload your profile picture');
  } else {
    // Check if the file is an image
    if (/^image\/\w+/.test(fileItem.type)) {
      // Initialize the cropper
      const image = document.getElementById('image_cropper');
      image.src = URL.createObjectURL(fileItem);
      cropper = new Cropper(image, {
        aspectRatio: 1 / 1,
        crop(event) {
          // Get the cropped canvas data as a data URL
          const canvas = cropper.getCroppedCanvas();
          const dataURL = canvas.toDataURL();
          
          // Set the data URL as the value of the hidden input field
          hiddenInput.value = dataURL;
        },
      });
    } else {
      toastr.error('Please choose an image file.');
    }
  }
});
}
function updateProfilePic(e, user) {
  e.preventDefault();
  e.stopPropagation();

  const canvas = cropper.getCroppedCanvas();
  canvas.toBlob((blob) => {
    const storageRef = ref(storage, 'profiles/' + user.uid);
    uploadBytes(storageRef, blob)
      .then((snapshot) => {
        toastr.success('You have updated the profile picture successfully');
        setTimeout(reloadPage, 1500);
      })
      .catch(err => {
        console.log('error uploading file', err);
        toastr.error('There was an error uploading the file');
      });
  });
}

function updateFileLabel() {
  const fileName = document.getElementById("fileName");
  fileName.innerHTML = updatedPicture.files[0].name;
}[]

    function showPrivateElements() {
      // User is signed in
      let publicElements = document.querySelectorAll("[data-onlogin='hide']");
      let privateElements = document.querySelectorAll("[data-onlogin='show']");
      privateElements.forEach(function(element) {
        element.style.display = "initial";
      });
      publicElements.forEach(function(element) {
        element.style.display = "none";
      });
    }

    function showPublicElements() {
      // User is signed out
      let publicElements = document.querySelectorAll("[data-onlogin='hide']");
      let privateElements = document.querySelectorAll("[data-onlogin='show']");
      publicElements.forEach(function(element) {
        element.style.display = "initial";
      });
      privateElements.forEach(function(element) {
        element.style.display = "none";
      });
    }

    let deleteButton = document.getElementById('delete_user');
    var storedLang = localStorage.getItem("language"); 

    if(deleteButton){
      deleteButton.addEventListener("click", async function(user){
        try {
          // Get the currently signed-in user
          var user = auth.currentUser;
          // Delete the user's account
          deleteUser(user).then(() => {
            if(storedLang == "de"){
              setTimeout(function() {
                  window.location.pathname = "/de/signin-porsche";                
                }, 1500);
            }else{
              setTimeout(function() {
                  window.location.pathname = "/en/signin-porsche";
                }, 1500);
            }
            toastr.success('User account deleted');       
            return deleteDoc(doc(db, "users", user.uid));
          }).catch((error) => {
            console.error('An error occurred while deleting the user account', error);
          });
          console.log("User's data deleted from Firestore");          
        } catch (error) {
          toastr.error('An error occurred while deleting the user account', error);
        }
      });
    }

    async function pageAccount(user) {
      let userInfo = await getUserInfo(user);
      const companyNames = await changeCompanyNameToID(userInfo);
      userInfo.user_company_name = companyNames;
      const userRef = doc(db, 'users', user.uid);
      // Populate form fields with values
      document.getElementById("user_email").innerHTML = `${user.email}`;
      document.getElementById("user_name").innerHTML = `${userInfo.user_firstname}`;
      document.getElementById("user_lastname").innerHTML = `${userInfo.user_lastname}`;
      document.getElementById("user_address").innerHTML = `${userInfo.user_address}`;
      if(userInfo.user_company_name == undefined){
        document.getElementById("company_name").innerHTML = 'No company';
      }else{
        document.getElementById("company_name").innerHTML = `${userInfo.user_company_name}`;
      }
      //Add first_sign = 1 to stop displaying the modal after second load
     setDoc(userRef, {              
      first_sign: "1",
      last_signin_date: new Date()
     }, { merge: true })
     .then(() => {
        console.log('press data successfully updated');
     })
     .catch((err) => {
        console.log('there was a problem signin user', err);
        toastr.error('There was an error signin user');
     })

      let update_email_modal = document.getElementById("email_form_modal");
      let update_password_modal = document.getElementById("password_form_modal");
      let update_picture_modal = document.getElementById("picture_form_modal");
      let change_email = document.getElementById("change_email");
      let confirm_email = document.getElementById('confirm_email');
      let change_username = document.getElementById("change_username");
      let change_password = document.getElementById("change_password");
      let confirm_password = document.getElementById("confirm_password");

      if ( update_email_modal !== null ) {
        update_email_modal.addEventListener('submit', function(ev) {
          ev.preventDefault();
          ev.stopPropagation();
          
          if(change_email.value == confirm_email.value){
            updateUserEmail(ev, user, change_email.value);
          }else{
            toastr.error('Email confirmation does not match');
          }
        }, true);
      }
      if ( update_password_modal) {
        update_password_modal.addEventListener('submit', function(e) {
          e.preventDefault();
          e.stopPropagation();

          if(change_password.value == confirm_password.value){
            updateUserPassword(e, user, change_password.value);
          }else{
            toastr.error('Password confirmation does not match');
          }
        }, true);
      }

      if ( update_picture_modal !== null ) {
        update_picture_modal.addEventListener('submit', function(ev) {
          updateProfilePic(ev, user);
        }, true);
      }
      showProfilePic(user);
      console.log(`Your ID: ${user.uid}`);
    }
    /*
    * -----------------------------------------------------------------------------------------------------------
    * Press functions
    * -----------------------------------------------------------------------------------------------------------
    */
    function pressFormSubmit(e, user) {
      e.preventDefault();
      e.stopPropagation();
      const userRef = doc(db, 'users', user.uid);
      const workspot = document.getElementById('workspot');
      const publisher = document.getElementById('publisher');
      const media_type = document.getElementById('media_type');
      const from_press_date = document.getElementById('Select-dates');
      const special_press_request = document.getElementById('special_press_request');
      const press_email = user.email;
      const press_id = document.getElementById('fileInp');

      if (press_id.files.length === 0) {
              toastr.error('Please upload your profile picture')
            }else{
            setDoc(userRef, {
              press_visit_dates: from_press_date.value,
              press_special_request: special_press_request.value,
              press_workspot: workspot.value,
              press_publisher: publisher.value,
              press_media_type: media_type.value,
              press_has_form_submitted: "1",
              press_email: press_email
            }, { merge: true })
            .then(() => {
              //console.log('press data successfully updated');
              pressUploadImage(user);
            })
            .catch((err) => {
              console.log('there was a problem updating the data', err);
              toastr.error('There was an error updating your info');
            });
          }
        }

    function pressUploadImage(user) {
      const press_id = document.getElementById('fileInp');
      let fileItem = press_id.files[0];
      const storageRef = ref(storage, 'press_id/' + user.uid);

      uploadBytes(storageRef, fileItem)
      .then((snapshot) => {
        toastr.success('You have submitted the form successfully');
        setTimeout(reloadPage, 3000);
      })
      .catch(err => {
        console.log('error uploading file', err);
        toastr.error('There was an error uploading the file');
      });
    }

    async function pagePress(user) {
      let userInfo = await getUserInfo(user);
      const userRef = doc(db, 'users', user.uid);
      let update_picture_modal = document.getElementById("picture_form_modal");
      const companyNames = await changeCompanyNameToID(userInfo);
        userInfo.user_company_name = companyNames;
      // Show displayName
      document.getElementById("client_press").innerHTML = `Hello ${userInfo.user_firstname} ${userInfo.user_lastname}`;
      if(userInfo.user_company_name == undefined){
        document.getElementById("company_name").innerHTML = 'No company';
      }else{
        document.getElementById("company_name").innerHTML = `${userInfo.user_company_name}`;
      }
      showProfilePic(user);

      // Get press form
      const press_form = document.getElementById('moreInfo_press_form');
      // Add submit event to form
      press_form.addEventListener('submit', function(ev) {
        pressFormSubmit(ev, user);
      });
      if ( update_picture_modal !== null ) {
        update_picture_modal.addEventListener('submit', function(ev) {
          updateProfilePic(ev, user);
        }, true);
      }
      // Display instruction modal
      if(userInfo.first_sign == "0"){
        document.getElementById('instructions_modal').style.display = "block";                 
      }else{
        document.getElementById('instructions_modal').style.display = "none";
      }
          //Add first_sign = 1 to stop displaying the modal after second load
          setDoc(userRef, {              
            first_sign: "1",
            last_signin_date: new Date()
          }, { merge: true })
          .then(() => {
              console.log('press data successfully updated');
          })
          .catch((err) => {
              console.log('there was a problem signin user', err);
              toastr.error('There was an error signin user');
          })
    }
    // Notify admin to make changes on the press form
    let press_notify_form = document.getElementById('notify_admin_modal');
    let notifier_email = document.getElementById('notifier_email');
    let notifier_text = document.getElementById('notifier_text');

    if(press_notify_form){
    press_notify_form.addEventListener('submit', function (e, user){
      e.preventDefault();
      e.stopPropagation();

      try {
            const docRef = addDoc(collection(db, "mail"), {
              to: 'dev@porschetennis.com',
              message: {
                subject: `Press form changes`,
                html: `Hi! The user ${notifier_email.value} wants to make the following changes:<br><br> ${notifier_text.value}.`,
              }
            });
            console.log("Email has been sent!");
          } catch (e) {
            console.error("Error adding document: ", e);
          }
          toastr.success('Email has been sent!');
          setTimeout(function() {
            document.getElementById('notify_modal').style.display = 'none';
            $('body').removeClass('modal-open');
                }, 500);
          
    })
  }
    /*
    * -----------------------------------------------------------------------------------------------------------
    * Supplier functions
    * -----------------------------------------------------------------------------------------------------------
    */

    function addSupplierInfo(e, user) {
      e.preventDefault();
      e.stopPropagation();

      const userRef = doc(db, 'users', user.uid);
      const select_dates = document.getElementById('Select-dates');
      const special_request = document.getElementById('Special-request-2');

      setDoc(userRef, {
        supplier_visit_dates: select_dates.value,
        supplier_special_request: special_request.value,
        supplier_has_form_submitted: "1"
      }, { merge: true })
      .then(() => {
        toastr.success('You have submitted the form successfully');
        setTimeout(reloadPage, 3000);
      })
      .catch((err) => {
        console.log('error updating supplier info', err);
        toastr.error('There was an error updating your info');
      });
    }

    function reloadPage(){
        window.location.reload();
    }

    async function pageSupplier(user) {
      let userInfo = await getUserInfo(user);
      const userRef = doc(db, 'users', user.uid);
      const companyNames = await changeCompanyNameToID(userInfo);
        userInfo.user_company_name = companyNames;
      // Show displayName
      document.getElementById("supplier_user").innerHTML = `Hello ${userInfo.user_firstname} ${userInfo.user_lastname}`;
      if(userInfo.user_company_name == undefined){
        document.getElementById("company_name").innerHTML = 'No company';
      }else{
        document.getElementById("company_name").innerHTML = `${userInfo.user_company_name}`;
      }
      showProfilePic(user);

      const supplier_form = document.getElementById('supplier_form');
      supplier_form.addEventListener('submit', function(ev) {
        ev.preventDefault();
        addSupplierInfo(ev, user);
      });
      let update_picture_modal = document.getElementById("picture_form_modal");
      if ( update_picture_modal !== null ) {
        update_picture_modal.addEventListener('submit', function(ev) {
          updateProfilePic(ev, user);
        }, true);
      }

      // Display instruction modal
      if(userInfo.first_sign == "0"){
        document.getElementById('instructions_modal').style.display = "block";                 
      }else{
        document.getElementById('instructions_modal').style.display = "none";
      }
      //Add first_sign = 1 to stop displaying the modal after second load
     setDoc(userRef, {              
      first_sign: "1",
      last_signin_date: new Date()
     }, { merge: true })
     .then(() => {
        console.log('press data successfully updated');
     })
     .catch((err) => {
        console.log('there was a problem signin user', err);
        toastr.error('There was an error signin user');
     })
     }

    // Notify admin to make changes on the supplier form
    let supplier_notify_form = document.getElementById('notify_supplier_form');
    let supplier_email = document.getElementById('supplier_notifier_email');
    let supplier_text = document.getElementById('supplier_notifier_text');

    if(supplier_notify_form){
      supplier_notify_form.addEventListener('submit', function (e, user){
      e.preventDefault();
      e.stopPropagation();

      try {
            const docRef = addDoc(collection(db, "mail"), {
              to: 'dev@porschetennis.com',
              message: {
                subject: `Supplier form changes`,
                html: `Hi! The user ${supplier_email.value} wants to make the following changes:<br><br> ${supplier_text.value}.`,
              }
            });
            console.log("Email has been sent!");
          } catch (e) {
            console.error("Error adding document: ", e);
          }
          toastr.success('Email has been sent!');
          setTimeout(function() {
            document.getElementById('supplier_notify_modal').style.display = 'none';
            $('body').removeClass('modal-open');
                }, 500);
    })
  }
      /*
      * -----------------------------------------------------------------------------------------------------------
      * Admin functions
      * -----------------------------------------------------------------------------------------------------------
      */

     async function pageAdmin(user) {
      
      changeAdminTypeTitle(user);

      let userInfo = await getUserInfo(user);
      const userRef = doc(db, 'users', user.uid);
      const companyNames = await changeCompanyNameToID(userInfo);
      userInfo.user_company_name = companyNames;
      if(userInfo.user_company_name == undefined){
        document.getElementById("company_name").innerHTML = 'No company';
      }else{
        document.getElementById("company_name").innerHTML = `${userInfo.user_company_name}`;
      }  

      // =========== USERS TABLE FUNCTIONS ============ //
      // Print users table
      const colRef = collection(db, 'users');
      const company_colRef = collection(db, 'companies');
      let searchInput = document.getElementById("search-input");
      let table = new Tabulator("#admin-user-list", {
       //options here
        layout:"fitData",
        overflow: 'x',
        responsiveLayout:"scroll",  //hide columns that dont fit on the table
        addRowPos:"top",          //when adding a new row, add it to the top of the table
        history:true,             //allow undo and redo actions on the table
        pagination:"local",     //paginate the data
        paginationSize:10,         //allow 10 rows per page of data.
        paginationSizeSelector:[10, 25, 50],
        paginationCounter:"rows", //display count of paginated rows in footer
        columns:[
            {title:"ID", field:"id", sorter:"string", width:0, cssClass:"hidden-column"},
            {title:"Company Admin", field:"company_admin", sorter:"string", width:0, cssClass:"hidden-column"},
            {title:"companyID", field:"companyID", sorter:"string", width:0, cssClass:"hidden-column"},
            { title: "user type", field: "user_type", sorter: "string", width: 0, cssClass: "hidden-column"},
            {title:"User Zones", field:"user_zones", sorter:"string", width:0, cssClass:"hidden-column"},
            {title:"First name", field:"name", sorter:"string", width:170, cssClass:"first_column"},
            {title:"Last name", field:"lastname", sorter:"string", width:170, cssClass:"other_columns"},
            {title:"Company", field:"company", sorter:"string", width:170, headerFilter:"list", headerFilterParams:{valuesLookup:true, clearable:true}, headerFilterPlaceholder: "Company", cssClass:"other_columns"},
            {title:"Status", field:"status", sorter:"string", width:170, headerFilter:"list", headerFilterParams:{valuesLookup:true, clearable:true}, headerFilterPlaceholder: "Status", cssClass:"other_columns"},
            {title:"Admin", field:"user_admin", cssClass:"center_col other_columns", width: 120, formatter:function(cell, formatterParams, onRendered){
                return cell.getValue() == 1 ? "Admin" : "";
            }},
            {title:"Actions", cssClass:"center_col other_columns", formatter:function(cell, formatterParams){
            let value = cell.getValue();
            let button = document.createElement("button");
            button.innerHTML = "Edit";
            button.setAttribute("onclick","openModal()");
            button.setAttribute("id","open_modal_btn");
            return button;
        }, align: "center", cssClass:"center_col other_columns", width: 120},
        {title: "Select", cssClass:"center_col other_columns", formatter:function(cell, formatterParams){
          let checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.addEventListener("click", function(){
                  let row = cell.getRow();
                  let rowData = row.getData();
                  let rowId = rowData.id;
                  if(checkbox.checked){
                      selectedData.push(rowId);
                  }else{
                      selectedData = selectedData.filter(function(value){
                          return value != rowId;
                      });
                  }
                  console.log(selectedData);
              });
              return checkbox;
          }, align: "center", width: 120},
        ],
});

$(document).ready(function() {
          $(".tabulator-paginator").find(".tabulator-page[data-page='prev']").html("&lt;");
          $(".tabulator-paginator").find(".tabulator-page[data-page='next']").html("&gt;");
        });

let selectedData = [];
console.log(selectedData);
const input = document.getElementById("fSearch");
input.addEventListener("keyup", function() {
    table.setFilter(matchAny, { value: input.value });
    if (input.value == " ") {
        table.clearFilter()
    }
});

function matchAny(data, filterParams) {
    var match = false;
    const regex = RegExp(filterParams.value, 'i');

    for (var key in data) {
        if (regex.test(data[key]) == true) {
            match = true;
        }
    }
    return match;
}
let clearFilterButton = document.getElementById('clear_button');
if (clearFilterButton) {
  clearFilterButton.addEventListener("click", function() {
    document.querySelector('input[placeholder="Company"]').value = "";
    document.querySelector('input[placeholder="Status"]').value = "";

    table.clearHeaderFilter();
  });
}

const companyAdmin = userInfo.company_admin;
const adminCompanyName = userInfo.user_company;
console.log('admin:', adminCompanyName)

getDocs(colRef)
  .then((snapshot) => {
    let data = [];
    let promises = [];
    snapshot.docs.forEach((doc) => {
        let user = doc.data();

        /*if (!user.user_company) {
            console.log(`User ${user.uid} does not have a user_company field defined`);
            return;
        }*/
        promises.push(changeCompanyNameToID(user).then(userCompanyName => {
          data.push({id: doc.id, company_admin: user.company_admin, companyID: [user.user_company], user_type: user.user_type, user_zones: user.user_zones, name: user.user_firstname, lastname: user.user_lastname, company: userCompanyName, status: user.user_status, user_admin: user.user_is_admin});

        }));
    });
    return Promise.all(promises).then(() => data);
  })
  .then(data => {
    console.log(data, 'admin', adminCompanyName);
    table.setData(companyAdmin == '1' ? data.filter(user => user.companyID.some(x => adminCompanyName.includes(x))) : data);
  })
  .catch(err => {
    console.log('error fetching users', err);
  });

    // Update single user Info
      let update_user_form = document.getElementById('update_user_type');
      let user_specific_id = document.getElementById('admin_user_id');
      let user_specific_email = document.getElementById('admin_user_email');
      let userTypeUpdate = document.getElementById('new_user_type');
      let user_status_update = document.getElementById('accountStatus');
      let user_company_update = document.getElementById('userCompany');
      let admin_cred = document.getElementById('is_admin');
      let company_admin = document.getElementById('headUser');
      let selectedUserZonesString = '';
      let selectedUserCompaniesString = '';
      const zonesSelect = document.getElementById('userZones');

      /*$('#userZones').on('change', function () {
        var selectedUserZones = $(this).val();
        selectedUserZonesString = selectedUserZones.join(', ');
      });*/
      $('#userCompany').on('change', function () {
        var selectedUserCompanies = $(this).val();
        selectedUserCompaniesString = selectedUserCompanies.join(', ');
      });

   // Update the selectedUserZonesString variable based on the current selection
function updateSelectedUserZonesString() {
  const selectedOptions = Array.from(zonesSelect.selectedOptions).map(option => option.value);
  selectedUserZonesString = selectedOptions.join(',');
}

// Update the zones based on the selected user type
userTypeUpdate.addEventListener('change', async () => {
  const userType = userTypeUpdate.value;
  if (userType !== '') {
    const profilesRef = doc(db, 'profiles', userType);
    try {
      const profilesSnapshot = await getDoc(profilesRef);
      if (profilesSnapshot.exists()) {
        const zones = profilesSnapshot.data().zones;
        // Update the options for the zones select
        const allOptions = zonesSelect.options;
        for (let i = 0; i < allOptions.length; i++) {
          const option = allOptions[i];
          if (zones.includes(option.value)) {
            option.selected = true;
          } else if (option.selected) {
            option.selected = false;
          }
        }
        $(zonesSelect).trigger('change.select2');
        // Update the selectedUserZonesString variable based on the current selection
        updateSelectedUserZonesString();
      } else {
        console.log('Error getting document(s):', error);
      }
    } catch (error) {
      console.log('Error getting document:', error);
    }
  } else {
    console.log('Error: "userType" is empty.');
  }
});

// Update the selectedUserZonesString variable whenever the zones select element changes
zonesSelect.addEventListener('change', () => {
  updateSelectedUserZonesString();
});


update_user_form.addEventListener('submit', (e) => {
  e.preventDefault();
  e.stopPropagation()

  if (user_specific_id != null || user_specific_id != 0) {
    const userRef = doc(db, 'users', user_specific_id.value);
    setDoc(userRef, {
      user_type: userTypeUpdate.value,
      user_status: user_status_update.value,
      user_company: selectedUserCompaniesString,
      user_zones: selectedUserZonesString,
      company_admin: company_admin.value,
    }, { merge: true })
      .then(() => {
        if (user_status_update.value == 'decline') {
          try {
            const docRef = addDoc(collection(db, "mail"), {
              to: `${user_specific_email.value}`,
              message: {
                subject: 'Sorry you have been declined',
                html: 'Sorry you have been declined',
              }
            });
          } catch (e) {
            console.error("Error declining user: ", e);
          }
          toastr.success('User registration declined');
        } else {
          try {
            const docRef = addDoc(collection(db, "mail"), {
              to: `${user_specific_email.value}`,
              message: {
                subject: 'Hello from Firebase!',
                html: 'This is an <code>HTML</code> email body.',
              }
            });
            console.log("Document written with ID: ", docRef.id);
          } catch (e) {
            console.error("Error adding document: ", e);
          }
          toastr.success('Account info has been successfully updated');
          document.getElementById('update_user_modal').style.display = 'none';
          $('body').removeClass('modal-open');
        }
      })
      .catch((err) => {
        toastr.error('There was an error updating the account info');
        console.log('error updating account info', err);
      });
  }
});
     //Bulk users update
     async function bulkUserUpdate(selectedData) {
    let bulk_user_form = document.getElementById('bulk_user_form');
    let bulk_status_update = document.getElementById('bulk_status');

    for (let i = 0; i < selectedData.length; i++) {
        const userRef = doc(db, 'users', selectedData[i]);
        const userData = await getDoc(userRef);
        if(userData.exists){
            setDoc(userRef, {
                user_status: bulk_status_update.value,
            }, { merge: true })
                .then(() => {
                  if(bulk_status_update.value == 'decline'){
                    if(storedLang == 'en'){
                      try {
                    const docRef = addDoc(collection(db, "mail"), {
                    to: `${userData.data().user_email}`,
                    message: {
                    subject: 'EN: Sorry you have been declined',
                    html: 'EN: Sorry you have been declined',
                    }
                    });
                    } catch (e) {
                    console.error("Error declining user: ", e);
                    }
                    toastr.success('User registration declined');
                    setTimeout(function() {
                      window.location.reload();
                    }, 1500);
                    }else{
                      try {
                    const docRef = addDoc(collection(db, "mail"), {
                    to: `${userData.data().user_email}`,
                    message: {
                    subject: 'DE: Sorry you have been declined',
                    html: 'DE: Sorry you have been declined',
                    }
                    });
                    } catch (e) {
                    console.error("Error declining user: ", e);
                    }
                    toastr.success('User registration declined');
                    setTimeout(function() {
                      window.location.reload();
                    }, 1500);
                    }
                }else{
                    if(storedLang == 'en'){
                      try {
                    const docRef = addDoc(collection(db, "mail"), {
                    to: `${userData.data().user_email}`,
                    message: {
                    subject: 'EN: Hello from Firebase!',
                    html: 'EN: This is an <code>HTML</code> email body.',
                    }
                    });
                    console.log("Document written with ID: ", docRef.id);
                    } catch (e) {
                    console.error("Error adding document: ", e);
                    }
                    toastr.success('Account info has been successfully updated');
                    setTimeout(function() {
                      window.location.reload();
                    }, 2000);
                    }else{
                      try {
                    const docRef = addDoc(collection(db, "mail"), {
                    to: `${userData.data().user_email}`,
                    message: {
                    subject: 'DE: Hello from Firebase!',
                    html: 'DE: This is an <code>HTML</code> email body.',
                    }
                    });
                    console.log("Document written with ID: ", docRef.id);
                    } catch (e) {
                    console.error("Error adding document: ", e);
                    }
                    toastr.success('Account info has been successfully updated');
                    setTimeout(function() {
                      window.location.reload();
                    }, 2000);
                    }
                  }
                })
                .catch((err) => {
                    toastr.error('There was an error updating the users info');
                    console.log('error updating users info', err);
                });
          }
        }
    }
    document.getElementById("bulk_user_form").addEventListener("submit", function(e){
      e.preventDefault();
      e.stopPropagation();
      bulkUserUpdate(selectedData);
    });

    //Print companies select
    let select = document.getElementById('userCompany');
      getDocs(company_colRef)
      .then((snapshot) => {
        snapshot.docs.forEach((doc) => {
          let company = doc.data();
          
          var opt = document.createElement('option');
          opt.value = doc.id;
          opt.textContent = company.company_name;
          select.appendChild(opt);
        });
      })
      .catch(err => {
        console.log('error fetching companies', err);
      })
      //Print profiles select
    let user_type_select = document.getElementById('new_user_type');
    const profilesRef = collection(db, 'profiles');
      getDocs(profilesRef)
      .then((snapshot) => {
        snapshot.docs.forEach((doc) => {
          let profile = doc.data();
          
          var opt = document.createElement('option');
          opt.value = doc.id;
          opt.textContent = profile.profile_name;
          user_type_select.appendChild(opt);
        });
      })
      .catch(err => {
        console.log('error fetching companies', err);
      })

      //Print zones select
      let update_user_zone = document.getElementById('userZones');
      const zonesRef = collection(db, 'zones');

      function createOptions(select) {
        getDocs(zonesRef)
          .then((snapshot) => {
            snapshot.docs.forEach((doc) => {
              let zone = doc.data();

              var opt = document.createElement('option');
              opt.value = zone.zone;
              opt.textContent = zone.zone;
              select.appendChild(opt);
            });
          })
          .catch(err => {
            console.log('error fetching companies', err);
          });
      }
          createOptions(update_user_zone);

          // Display instruction modal
      if(userInfo.first_sign == "0"){
        document.getElementById('instructions_modal').style.display = "block";
        $('body').addClass('modal-open');               
      }else{
        document.getElementById('instructions_modal').style.display = "none";
        $('body').removeClass('modal-open');
      }
          //Add first_sign = 1 to stop displaying the modal after second load
        setDoc(userRef, {              
          first_sign: "1",
          last_signin_date: new Date()
        }, { merge: true })
        .then(() => {
            console.log('press data successfully updated');
        })
        .catch((err) => {
            console.log('there was a problem signin user', err);
            toastr.error('There was an error signin user');
        })
    }
    /*
    * --------------------------------------------------------------------------------------------
    *  Companies table page functions
    * --------------------------------------------------------------------------------------------
    */
    async function pageCompaniesTable(user){ 

      changeAdminTypeTitle(user)

    // Print companies table
    const company_colRef = collection(db, 'companies');
      let searchCompanyInput = document.getElementById("search-input");
      let companies_table = new Tabulator("#admin-companies-list", {
        //options here
        layout:"fitData",
        overflow:'x',
        responsiveLayout:"scroll",
        addRowPos:"top",
        history:true,
        pagination:"local",
        paginationSize:10,
        paginationSizeSelector:[10, 25, 50],
        paginationCounter:"rows",
        columns:[
        {title:"Company Link", field:"companyLink", sorter:"string", width:0, cssClass:"hidden-column companyLinkToCopy", formatter: function(cell, formatterParams, onRendered){
                let companyLink = cell.getValue();
                cell.getElement().setAttribute("id", "companyLink"+cell.getRow().getData().id);
                return companyLink;
            }},
            {title:"ID", field:"id", sorter:"string", width:0, cssClass:"companyID hidden-column"},
            {title:"Company Profile", field:"company_profile", sorter:"string", width:0, cssClass:"companyProfile hidden-column"},
            {title:"Company", field:"company", sorter:"string", width:300, cssClass:"companyName first_column"},
            {title:"Company Zone", field:"zone", sorter:"string", width:400, cssClass:"companyZone other_columns"},
            {title:"User Head", field:"userHead", sorter:"string", width:0, cssClass:"userHead hidden-column"},
            {title:"Send Link", width:200, cssClass:"other_columns center_column", formatter:function(cell, formatterParams){
            let value = cell.getValue();
            let button = document.createElement("button");
            button.innerHTML = "Send Link";
            button.setAttribute("onclick","openModal5()");
            button.setAttribute("id","open_link_modal");
            return button;
            }},
            {title:"Update", width:200, cssClass:"other_columns center_column", formatter:function(cell, formatterParams){
            let value = cell.getValue();
            let button = document.createElement("button");
            button.innerHTML = "Edit";
            button.setAttribute("onclick","openModal2()");
            button.setAttribute("id","open_companies_modal");
            return button;
        }},           
            
        ],
    });

  $(document).ready(function() {
          $(".tabulator-paginator").find(".tabulator-page[data-page='prev']").html("&lt;");
          $(".tabulator-paginator").find(".tabulator-page[data-page='next']").html("&gt;");
        });

    const company_input = document.getElementById("company_search");
    company_input.addEventListener("keyup", function() {
      companies_table.setFilter(matchAny, { value: company_input.value });
        if (company_input.value == " ") {
          companies_table.clearFilter()
        }
    });

    function matchAny(data, filterParams) {
        var match = false;
        const regex = RegExp(filterParams.value, 'i');

        for (var key in data) {
            if (regex.test(data[key]) == true) {
                match = true;
            }
        }
        return match;
    }

  getDocs(company_colRef)
    .then((snapshot) => {
        let data = [];
        snapshot.docs.forEach((doc) => {
            let company = doc.data();
            let company_link = `https://porsche-tms.webflow.io/en/signup-porsche?company=${doc.id}`
                data.push({companyLink: company_link, company_profile: company.company_profile,  id:doc.id, userHead: company.user_head, company: company.company_name, zone: company.company_zones});
                companies_table.setData(data);
        });
    })
    .catch(err => {
        console.log('error fetching users', err);
    });

      //Update company info
      let update_company_form = document.getElementById('update_company_info');
      let company_id = document.getElementById('company_id');
      let update_company = document.getElementById('update_company');
      let newCompanyProfile = document.getElementById('newCompanyProfile');
      let selectedNewZonesString;

      $('#newCompanyZones').on('change', function () {
        var selectedNewZones = $(this).val();
        selectedNewZonesString = selectedNewZones.join(', ');
      });
      update_company_form.addEventListener('submit', (e) => {
        e.preventDefault();
        e.stopPropagation()

        if ( company_id != null) {
          const companyRef = doc(db, 'companies', company_id.value);
          setDoc(companyRef, {
            company_name: update_company.value,
            company_zones: selectedNewZonesString,
            company_profile: newCompanyProfile.value
          }, { merge: true })
          .then(() => {
                toastr.success('Company info has been successfully updated');
                setTimeout(function() {
                  window.location.reload();
                }, 2000);
          })
          .catch((err) => {
            toastr.error('There was an error updating the company info');
            console.log('error updating company info', err);
          });
        }
      });
      
      //Create companies
      let create_company_form = document.getElementById('create_company_form');
      let new_company_name = document.getElementById('newCompanyName');
      let new_company_profile = document.getElementById('companyProfile');
      let new_company_type = document.getElementById('company_type');
      let companyZone = document.getElementById('companyZone');
      let selectedValuesString;

      $('#companyZone').on('change', function () {
        var selectedValues = $(this).val();
        selectedValuesString = selectedValues.join(', ');
      });

      async function createCompany() {
        const companyRef = await addDoc(collection(db, "companies"), {
            company_name: new_company_name.value,
            company_zones: selectedValuesString,
            company_profile: new_company_profile.value,
            company_type: new_company_type.value,
            user_head: ''
          })
          .then(() => {
            toastr.success('Company has been successfully created');
            setTimeout(function() {
              window.location.reload();
            }, 2000);
          })
          .catch((err) => {
            toastr.error('There was an error creating the company');
            console.log('error creating company', err);
          });
      }
      create_company_form.addEventListener('submit', (e) => {
        e.preventDefault();
        e.stopPropagation();

        createCompany();
      });

      //Create Profiles
      let create_profile_form = document.getElementById('create_profile_form');
      let new_profile_name = document.getElementById('newProfileName');
      let profileZones = document.getElementById('profileZones');
      let selectedProfileZones;

      $('#profileZones').on('change', function () {
        var selectedValues = $(this).val();
        selectedProfileZones = selectedValues.join(', ');
      });

      async function createProfile() {
        const profileRef = await addDoc(collection(db, "profiles"), {
            profile_name: new_profile_name.value,
            zones: selectedProfileZones,
          })
          .then(() => {
            toastr.success('Profile has been successfully created');
            setTimeout(function() {
              document.getElementById('create_profile_modal').style.display = 'none';
            }, 500);
            $('body').removeClass('modal-open')
          })
          .catch((err) => {
            toastr.error('There was an error creating the profile');
            console.log('error creating profile', err);
          });
      }
      create_profile_form.addEventListener('submit', (e) => {
        e.preventDefault();
        e.stopPropagation();

        createProfile();
      });

    //Create new zones
    if (window.location.pathname == '/de/admin/users-table' || window.location.pathname == '/de/admin/companies-table' || window.location.pathname == '/en/admin/users-table' || window.location.pathname == '/en/admin/companies-table'){
      let create_zone_form = document.getElementById('create_zone_form');
      let new_zone_name = document.getElementById('newZoneName');

      async function createZone(){
        const zoneRef = await addDoc(collection(db, "zones"), {
            zone: new_zone_name.value,
          })
          .then(() => {
                toastr.success('Zone has been successfully created');
                setTimeout(function() {
                  document.getElementById('#zone_modal').style.display = 'none';
                  $('body').removeClass('modal-open')
                }, 500);
          })
          .catch((err) => {
            toastr.error('There was an error creating the zone');
            console.log('error creating zone', err);
          });
      }

      create_zone_form.addEventListener('submit', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        createZone()
      });

      //Print zones select
      let create_company_zone = document.getElementById('companyZone');
      let update_company_zone = document.getElementById('newCompanyZones');
      let update_user_zone = document.getElementById('userZones');
      let profileZones = document.getElementById('profileZones');
      const zonesRef = collection(db, 'zones');

      function createOptions(select) {
        getDocs(zonesRef)
          .then((snapshot) => {
            snapshot.docs.forEach((doc) => {
              let zone = doc.data();

              var opt = document.createElement('option');
              opt.value = zone.zone;
              opt.textContent = zone.zone;
              select.appendChild(opt);
            });
          })
          .catch(err => {
            console.log('error fetching companies', err);
          });
      }
          createOptions(create_company_zone);
          createOptions(update_company_zone);
          createOptions(update_user_zone);
          createOptions(profileZones);

        //Print profiles select
      let companyProfile = document.getElementById('companyProfile');
      let newCompanyProfile = document.getElementById('newCompanyProfile')
      const profilesRef = collection(db, 'profiles');

        function createProfileOptions(select) {
          getDocs(profilesRef)
            .then((snapshot) => {
              snapshot.docs.forEach((doc) => {
                let profile = doc.data();

                var opt = document.createElement('option');
                opt.value = doc.id;
                opt.textContent = profile.profile_name;
                select.appendChild(opt);
              });
            })
            .catch(err => {
              console.log('error fetching companies', err);
            });
        }
            createProfileOptions(companyProfile);
            createProfileOptions(newCompanyProfile);
            console.log('Lluvia fina')

             // Update the selectedUserZonesString variable based on the current selection
            function updateSelectedCompanyZonesString() {
              const selectedOptions = Array.from(newCompanyZones.selectedOptions).map(option => option.value);
              selectedNewZonesString = selectedOptions.join(',');
            }

            let newCompanyZones = document.getElementById('newCompanyZones');
            // Update the zones based on the selected company profile
            newCompanyProfile.addEventListener('change', async () => {
              const companyProfile = newCompanyProfile.value;
              if (companyProfile !== '') {
                const profilesRef = doc(db, 'profiles', companyProfile);
                try {
                  const profilesSnapshot = await getDoc(profilesRef);
                  if (profilesSnapshot.exists()) {
                    const zones = profilesSnapshot.data().zones;
                    // Update the options for the zones select
                    const allOptions = newCompanyZones.options;
                    for (let i = 0; i < allOptions.length; i++) {
                      const option = allOptions[i];
                      if (zones.includes(option.value)) {
                        option.selected = true;
                      } else if (option.selected) {
                        option.selected = false;
                      }
                    }
                    $(newCompanyZones).trigger('change.select2');
                    // Update the selectedUserZonesString variable based on the current selection
                    updateSelectedCompanyZonesString();
                  } else {
                    console.log('Error getting document(s):', error);
                  }
                } catch (error) {
                  console.log('Error getting document:', error);
                }
              } else {
                console.log('Error: "userType" is empty.');
              }
             });

              // Update the selectedUserZonesString variable whenever the zones select element changes
              newCompanyZones.addEventListener('change', () => {
                updateSelectedCompanyZonesString();
              });

              // Update the selectedUserZonesString variable based on the current selection
            function updateCompanyZonesString() {
              const selectedOptions = Array.from(companyZones.selectedOptions).map(option => option.value);
              selectedValuesString = selectedOptions.join(',');
            }

            let companyZones = document.getElementById('companyZone');
            let createCompanyProfile = document.getElementById('companyProfile');
            // Update the zones based on the selected company profile
            createCompanyProfile.addEventListener('change', async () => {
              const companyProfile = createCompanyProfile.value;
              if (companyProfile !== '') {
                const profilesRef = doc(db, 'profiles', companyProfile);
                try {
                  const profilesSnapshot = await getDoc(profilesRef);
                  if (profilesSnapshot.exists()) {
                    const zones = profilesSnapshot.data().zones;
                    // Update the options for the zones select
                    const allOptions = companyZones.options;
                    for (let i = 0; i < allOptions.length; i++) {
                      const option = allOptions[i];
                      if (zones.includes(option.value)) {
                        option.selected = true;
                      } else if (option.selected) {
                        option.selected = false;
                      }
                    }
                    $(companyZones).trigger('change.select2');
                    // Update the selectedUserZonesString variable based on the current selection
                    updateCompanyZonesString();
                  } else {
                    console.log('Error getting document(s):', error);
                  }
                } catch (error) {
                  console.log('Error getting document:', error);
                }
              } else {
                console.log('Error: "userType" is empty.');
              }
             });

              // Update the selectedUserZonesString variable whenever the zones select element changes
              newCompanyZones.addEventListener('change', () => {
                updateCompanyZonesString();
              });
          }
      }

    //Company page
    $(document).on( 'click' , '#companyName' ,async function() {
          let storedLang = localStorage.getItem("language");
          let companyValue = event.target.getAttribute('data-value');
          let companyNameValue = event.target.getAttribute('data-company-name');
          const q = query(collection(db, "users"), where("user_company", "==", companyValue));
          const company_filter = query(collection(db, "companies"), where("company_name", "==", companyNameValue));
          const companySnapshot = await getDocs(company_filter);
          const querySnapshot = await getDocs(q);
          let users = [];
          let company = [];

          querySnapshot.forEach((doc) => {
            let user = doc.data(q);
            users.push(user)
          });
           //Get company name from the companies collection
          companySnapshot.forEach((doc) => {
            let company_name = doc.data(company_filter);
            company.push(company_name)
          });

          console.log(company)
          localStorage.setItem('users', JSON.stringify(users));
          localStorage.setItem('company', companyValue);          

          //Save company name from the companies collection
          localStorage.setItem('company_collection', JSON.stringify(company));

          if(storedLang){
            if(storedLang == "de"){
              window.location.replace('/de/company');
            }else{
              window.location.replace('/en/company');
            }
          }else{
            window.location.replace('/en/company');
          }         
      })

    if (window.location.pathname == '/de/company'){
      // Retrieve users data from local storage
      const storedUsers = localStorage.getItem('users');
      const company_name = localStorage.getItem('company');
      const company_collection = localStorage.getItem('company_collection');
      const parseCompany = JSON.parse(company_collection);
      const users = JSON.parse(storedUsers);

    // Add rows and cells to table
    users.forEach(function(user) {
      var newRow = document.getElementById('company-user-list-body').insertRow(0);
      let idCell = newRow.insertCell(0);
      let emailCell = newRow.insertCell(1);
      let userTypeCell = newRow.insertCell(2);
      idCell.innerHTML = `${user.user_id}`;
      emailCell.innerHTML = `${user.user_email}`;
      userTypeCell.innerHTML = `${user.user_type}`;
    });

    //Add company head
        parseCompany.forEach(function(company){
      if(company.hasOwnProperty('user_head')){
        document.getElementById('user_head').innerHTML = `User head: ${company.user_head}`
      }
      if(company.hasOwnProperty('company_name')){
        document.getElementById('company_table_name').innerHTML = `Company: ${company.company_name}`
      }
    })
  }

  // Send email with the user's registration link
    let company_link_form = document.getElementById('company_link_form');

    if(company_link_form){
      company_link_form.addEventListener('submit', (e)=>{
        e.preventDefault();
        e.stopPropagation();

              try {
                    const docRef = addDoc(collection(db, "mail"), {
                    to: `${email_to_send.value}`,
                    message: {
                    subject: 'Hello! Heres is the registration link',
                    html:  `${company_link.value}`,
                    }
                    });
                    toastr.success('Email has been successfully sent');
                    setTimeout(function() {
                      document.getElementById('company_link_modal').style.display = 'none'
                    }, 500);
                    } catch (e) {
                      toastr.error("Error sending email: ", e);
                    }
                })
              }

    /*
    * -----------------------------------------------------------------------------------------------------------
    * URL functions
    * -----------------------------------------------------------------------------------------------------------
    */

    /* Check if the company parameter exists in the URL
    /* If it does then set a value in the local storage
    /* and pre-populate the text field in the sign up form
    **/
    function checkUrlParameter() {

      let url = new URL(window.location.href);
      let company = url.searchParams.get('company');

      if ( company ) {
          localStorage.setItem('company', company);
          $('#sign-up-company').val(company);
      }else{
        $('#sign-up-company').val('No company');
      }
    }

    function dispatchRequest(user) {
      let url = window.location.pathname;
      console.log('url in dispatchRequest()', url);

      // User is NOT signed in
      if ( user == false ) {
        // Homepage

        let signOutbutton = document.getElementById('signout-button');
         if(signOutbutton){
          signOutbutton.style.display = 'none';
         }
        if ( url == '/en/signup-porsche' || url == '/de/signup-porsche' ) {
          pageHome();
        } else if ( url == '/en/signin-porsche' || url == '/de/signin-porsche' ) {
          signInPage();
        } else {
          // User does NOT have access to this page
          console.log('user does NOT have access to this page');
        }
      } else {
        document.getElementById('signout-button').style.display = 'block';
        // User IS signed in
         if ( url == '/en/account' || url == '/de/account' ) {
          pageAccount(user);
        } else if ( url == '/en/press' || url == '/de/press' ) {
          pagePress(user);
        } else if ( url == '/en/supplier' || url == '/de/supplier' ) {
          pageSupplier(user);
        } else if ( url == '/en/admin/users-table' || url == '/de/admin/users-table' ) {
          pageAdmin(user);
        }else if ( url == '/en/admin/companies-table' || url == '/de/admin/companies-table' ) {
          pageCompaniesTable(user);
        }
      }
    }
    // Forgot password functionality
    if(window.location.pathname == '/en/forgotpassword' || window.location.pathname == '/de/forgotpassword'){
      var storedLang = localStorage.getItem("language");
      let email = document.getElementById('email_address');
      let resetPasword = document.getElementById('forgot_password');

      resetPasword.addEventListener('submit', function(e){
        e.preventDefault();
        e.stopPropagation();

        localStorage.setItem('email', JSON.stringify(email.value));

        sendPasswordResetEmail(auth, email.value)
        .then(() => {
          toastr.success('Email has been sent!');
          setTimeout(function() {

            if(storedLang){
              if(storedLang == "de"){
                window.location.pathname = '/de/success-email-sent';
              }else{
                window.location.pathname = '/en/success-email-sent';
              }
            }else{
              window.location.pathname = '/en/success-email-sent';
            }
                }, 2000);
        })
        .catch((error) => {
          const errorCode = error.code;
          const errorMessage = error.message;
          toastr.error('There was an error');
          // ..
        });
      })
    };

    if(window.location.pathname == '/success-email-sent'){
      let forgot_password_email = localStorage.getItem('email');
      document.getElementById('email_confirmation_text').innerHTML = `We sent a password reset link to ${forgot_password_email}`;
    }
    
    //Location redirect when the user is logged out
    function replaceUrl(user) {
        let form_button = document.getElementById('form_button');
        let account_button = document.getElementById('account_user_profile');
        let users_button = document.getElementById('users_table');
        let companies_button = document.getElementById('companies_table');
        var storedLang = localStorage.getItem("language");

      if(!user){
        if(storedLang){
          if(storedLang == "de"){
            form_button.setAttribute('href', '/de/signin-porsche');
            account_button.setAttribute('href', '/de/signin-porsche');
            users_button.setAttribute('href', '/de/signin-porsche');
            companies_button.setAttribute('href', '/de/signin-porsche');
            document.getElementById('signIn_button').style.display = 'block'; 
            document.getElementById('signUp_button').style.display = 'block';
            if(window.location.pathname == '/'){
              window.location.replace('https://porsche-tms.webflow.io/de/signin-porsche');
              }
          }else{
            form_button.setAttribute('href', '/en/signin-porsche');
            account_button.setAttribute('href', '/en/signin-porsche');
            users_button.setAttribute('href', '/de/signin-porsche');
            companies_button.setAttribute('href', '/de/signin-porsche');
            document.getElementById('signIn_button').style.display = 'block'; 
            document.getElementById('signUp_button').style.display = 'block';
            if(window.location.pathname == '/'){
              window.location.replace('https://porsche-tms.webflow.io/en/signin-porsche');
              }
          }
        }else{
          form_button.setAttribute('href', '/en/signin-porsche');
          account_button.setAttribute('href', '/en/signin-porsche');
          users_button.setAttribute('href', '/de/signin-porsche');
          companies_button.setAttribute('href', '/de/signin-porsche');
          document.getElementById('signIn_button').style.display = 'block'; 
          document.getElementById('signUp_button').style.display = 'block';
        }        
      }else{
        if(storedLang){
          if(storedLang == "de"){
            account_button.setAttribute('href', '/de/account');
            users_button.setAttribute('href', '/de/admin/users-table');
            companies_button.setAttribute('href', '/de/admin/companies-table');
            document.getElementById('signIn_button').style.display = 'none'; 
            document.getElementById('signUp_button').style.display = 'none';
            if(window.location.pathname == '/'){
              window.location.replace('https://porsche-tms.webflow.io/de/account');
            }
          }else{
            account_button.setAttribute('href', '/en/account');
            users_button.setAttribute('href', '/en/admin/users-table');
            companies_button.setAttribute('href', '/en/admin/companies-table');
            document.getElementById('signIn_button').style.display = 'none'; 
            document.getElementById('signUp_button').style.display = 'none';
            if(window.location.pathname == '/'){
              window.location.replace('https://porsche-tms.webflow.io/en/account');
            }
          }
        }else{
              account_button.setAttribute('href', '/en/account');
              users_button.setAttribute('href', '/en/admin/users-table');
              companies_button.setAttribute('href', '/en/admin/companies-table');
              document.getElementById('signIn_button').style.display = 'none'; 
              document.getElementById('signUp_button').style.display = 'none';
              if(window.location.pathname == '/'){
                window.location.replace('https://porsche-tms.webflow.io/en/account');
              }
            }        
        }
      }
    // first page load
    const loadingOverlay = document.querySelector(".loading-overlay");
    if(loadingOverlay){
    setTimeout(function() {      
      loadingOverlay.style.display = "none";
    }, 2000);
  }
    dispatchRequest(false);
    checkUrlParameter();

    async function changeCompanyNameToID(user) {
    // Get the collection of companies
    const companiesRef = collection(db, "companies");
    // Get all the company documents
    const companiesSnapshot = await getDocs(companiesRef);
    let companyNames = [];
    // Iterate over the companies and find the ones with the matching IDs
    for (const company of companiesSnapshot.docs) {
        if (user.user_company.includes(company.id)) {
            companyNames.push(company.data().company_name);
        }
    }
    // If one or more companies with the matching IDs are found
    if (companyNames.length > 0) {
        // Return the company names
        return companyNames.join(", ");
    } else {
        console.log("No company found with that ID");
    }
}

async function getCompanyType(user) {
    let userInfo = await getUserInfo(user);
    // Get the collection of companies
    const companiesRef = collection(db, "companies");
    // Get all the company documents
    const companiesSnapshot = await getDocs(companiesRef);
    let companyProfile = 'No company';
    let companyZones = [];
    // Iterate over the companies and find the one with the matching ID
    for (const company of companiesSnapshot.docs) {
        if (company.id === userInfo.user_company) {
          companyProfile = company.data().company_type;
            companyZones = company.data().company_zones || [];
            break;
        }
    }
    // If a company with the matching ID is found
    if (companyProfile) {
        // Return an object with the company type and zones
        return { companyProfile, companyZones };
    } else {
        console.log("No company found with that ID");
    }
}
    onAuthStateChanged(auth, (user) => {
      replaceUrl(user);
      if (user) {
        // user is signed in
        console.log(`The current user's UID is equal to ${user.uid}`);
        
        dispatchRequest(user);
        populateForms(user);
        showPrivateElements();
        
      } else {
        // user is signed out
        showPublicElements();
        return;
      }
    });
    $(document).ready(function () {
  var today = new Date();
  var minDate = new Date(today.getFullYear(), 3, 15);
  var maxDate = new Date(today.getFullYear(), 3, 23);
  var startDatePicker = $('[data-date-picker="datepicker-start"]');

  startDatePicker.datepicker({
    multipleDates: true,
    multipleDatesSeparator: ', ',
    dateFormat: 'mm-dd-yyyy',
    minDate: minDate,
    maxDate: maxDate,
    language: 'en',
    onHide: function(inst, animationCompleted) {
      var selectedDates = inst.selectedDates;
      console.log(selectedDates); // log the selected dates
    }
  });

  if (window.innerWidth < 768) {
    $('[data-date-picker]').attr('readonly', 'readonly');
  }
});
    //Language selection
    var currentLang = "en";  // default language is English
    let reloaded = false;

    function changeLanguage(lang) {
        localStorage.setItem("language", lang);
        var currentPath = window.location.pathname;
        var pathArray = currentPath.split("/");
        if(pathArray.length < 3 || (pathArray.length >= 3 && !/^[a-z]{2}$/.test(pathArray[1]))){
            currentPath = '/'+lang+currentPath;
        }else{
            currentPath = currentPath.replace(/\/[a-z]{2}\//, '/' + lang + '/');
        }
        window.history.pushState({}, null, currentPath);
        if (!reloaded) {
            reloaded = true;
            location.reload();
        }
    }

    window.addEventListener('load', function(){
      var storedLang = localStorage.getItem("language");
      if(storedLang){
          currentLang = storedLang;
      }
      updateLinks();
    });

    function updateLinks() {
      console.log("Updating links");
      var baseUrl = window.location.origin;
      var currentPath = window.location.pathname;
      var pathArray = currentPath.split("/");
      if(pathArray.length < 3 || (pathArray.length >= 3 && !/^[a-z]{2}$/.test(pathArray[1]))){
          currentPath = '/'+currentLang+currentPath;
      }
      var links = document.querySelectorAll(".nav-link");
      if(links){
        for (var i = 0; i < links.length; i++) {
          var link = links[i];
          if(!link.href.startsWith(baseUrl)){
              link.href = baseUrl + currentPath + link.getAttribute("href");
          }
      }
      }
    }
    //Update the language select name
    var storedLang = localStorage.getItem("language");
    let sign_lang = document.getElementById('selected_lang2');
      if(storedLang){
        if(storedLang == "de"){
        document.getElementById('selected_lang').innerHTML = "DE";
        if(sign_lang){
          sign_lang.innerHTML = "DE";
        }
      }else{
        document.getElementById('selected_lang').innerHTML = "EN";
        if(sign_lang){
          sign_lang.innerHTML = "EN";
        }
      }
      }else{
        document.getElementById('selected_lang').innerHTML = "EN";
        if(sign_lang){
          sign_lang.innerHTML = "EN";
        }
      }
    
    document.getElementById("englishBtn").addEventListener("click", function() {
        changeLanguage("en");
        updateLinks();
        document.getElementById('selected_lang').innerHTML = "EN";
    });
    document.getElementById("germanBtn").addEventListener("click", function() {
        changeLanguage("de");
        updateLinks();
        document.getElementById('selected_lang').innerHTML = "DE";
    });

    let signEnBtn = document.getElementById("englishBtn2")
    if(signEnBtn){
      signEnBtn.addEventListener("click", function() {
        changeLanguage("en");
        updateLinks();
    });
    }
    let signDeBtn = document.getElementById("germanBtn2")
    if(signDeBtn){
      signDeBtn.addEventListener("click", function() {
        changeLanguage("de");
        updateLinks();
    });
    }

    let form_button = document.getElementById('form_button');
    let admin_users_table = document.getElementById("users_table");
    let admin_companies_table = document.getElementById("companies_table");

    if(window.location.pathname == '/de/press' || window.location.pathname == '/en/press' || window.location.pathname == '/de/supplier' || window.location.pathname == '/en/supplier'){
      form_button.style.borderBottom = "2px solid #f2a100";
    }
    if(window.location.pathname == '/en/admin/users-table' || window.location.pathname == '/de/admin/users-table'){
      admin_users_table.style.borderBottom = "2px solid #f2a100";
    }
    if(window.location.pathname == '/en/admin/companies-table' || window.location.pathname == '/de/admin/companies-table'){
      admin_companies_table.style.borderBottom = "2px solid #f2a100";
    }

    let welcomeBanner = document.getElementById('welcomeBanner');
    if(welcomeBanner){
      if (location.search.indexOf('?company=') !== -1) {
      welcomeBanner.style.display = 'flex';
      } else {
        welcomeBanner.style.display = 'none';
      }
    }

    async function changeAdminTypeTitle(user){
      let userInfo = await getUserInfo(user);
      let storedLang = localStorage.getItem("language");

      if(storedLang == 'en'){
        if(userInfo.user_is_admin === '0' && userInfo.company_admin === '1') {
          document.getElementById('user_admin_type').innerHTML = 'Company Admin';
        }else if(userInfo.user_is_admin === '1') {
          document.getElementById('user_admin_type').innerHTML = 'Super Admin';
        }
      }else{
        if(userInfo.user_is_admin === '0' && userInfo.company_admin === '1') {
          document.getElementById('user_admin_type').innerHTML = 'Firmenadministrator';
          }else if(userInfo.user_is_admin === '1') {
            document.getElementById('user_admin_type').innerHTML = 'Superadministrator';
          }
      }
    }

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
</html>